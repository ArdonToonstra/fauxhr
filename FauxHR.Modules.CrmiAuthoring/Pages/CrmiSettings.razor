@page "/crmi/settings"
@using FauxHR.Modules.CrmiAuthoring.Services
@inject ValueSetBindingService BindingService
@inject TerminologyService TerminologyService

<h3 class="mb-4">
    <i class="bi bi-gear me-2"></i>CRMI Authoring Settings
</h3>

<div class="row">
    <div class="col-12">
        <div class="card">
            <div class="card-header d-flex justify-content-between align-items-center">
                <h5 class="mb-0">
                    <i class="bi bi-link-45deg me-2"></i>ValueSet Bindings
                </h5>
                <button class="btn btn-primary btn-sm" @onclick="ShowAddBindingModal">
                    <i class="bi bi-plus-lg me-1"></i>Add Binding
                </button>
            </div>
            <div class="card-body">
                <p class="text-muted mb-3">
                    Configure which ValueSets or CodeSystems should provide dropdown options for specific FHIR elements.
                    When a binding is configured, the code selector will show a dropdown instead of free-text entry.
                </p>

                @if (_isLoading)
                {
                    <div class="d-flex align-items-center gap-2">
                        <div class="spinner-border spinner-border-sm" role="status">
                            <span class="visually-hidden">Loading...</span>
                        </div>
                        <span class="text-muted">Loading bindings...</span>
                    </div>
                }
                else if (!_bindings.Any())
                {
                    <div class="alert alert-info mb-0">
                        <i class="bi bi-info-circle me-2"></i>
                        No ValueSet bindings configured yet. Click "Add Binding" to create one.
                    </div>
                }
                else
                {
                    <div class="table-responsive">
                        <table class="table table-hover mb-0">
                            <thead class="table-light">
                                <tr>
                                    <th>Element Path</th>
                                    <th>ValueSet/CodeSystem URL</th>
                                    <th>Codes</th>
                                    <th style="width: 100px;">Actions</th>
                                </tr>
                            </thead>
                            <tbody>
                                @foreach (var binding in _bindings)
                                {
                                    <tr>
                                        <td>
                                            <code>@binding.Value.ElementPath</code>
                                        </td>
                                        <td>
                                            <span class="text-truncate d-inline-block" style="max-width: 400px;" 
                                                  title="@binding.Value.ValueSetUrl">
                                                @(binding.Value.DisplayName ?? binding.Value.ValueSetUrl)
                                            </span>
                                        </td>
                                        <td>
                                            @if (_codeCountsLoading.Contains(binding.Key))
                                            {
                                                <span class="spinner-border spinner-border-sm"></span>
                                            }
                                            else if (_codeCounts.TryGetValue(binding.Key, out var count))
                                            {
                                                <span class="badge bg-secondary">@count codes</span>
                                            }
                                            else
                                            {
                                                <button class="btn btn-link btn-sm p-0" @onclick="() => LoadCodeCount(binding.Key)">
                                                    Load
                                                </button>
                                            }
                                        </td>
                                        <td>
                                            <div class="btn-group btn-group-sm">
                                                <button class="btn btn-outline-primary" title="Edit" 
                                                        @onclick="() => EditBinding(binding.Value)">
                                                    <i class="bi bi-pencil"></i>
                                                </button>
                                                <button class="btn btn-outline-danger" title="Delete"
                                                        @onclick="() => DeleteBinding(binding.Key)">
                                                    <i class="bi bi-trash"></i>
                                                </button>
                                            </div>
                                        </td>
                                    </tr>
                                }
                            </tbody>
                        </table>
                    </div>
                }
            </div>
        </div>
    </div>
</div>

<!-- Common Element Paths Reference -->
<div class="row mt-4">
    <div class="col-12">
        <div class="card">
            <div class="card-header">
                <h5 class="mb-0">
                    <i class="bi bi-book me-2"></i>Common Element Paths
                </h5>
            </div>
            <div class="card-body">
                <p class="text-muted mb-3">
                    Reference for common FHIR element paths that can be bound to ValueSets:
                </p>
                <div class="row">
                    <div class="col-md-6">
                        <h6>ActivityDefinition</h6>
                        <ul class="list-unstyled small">
                            <li><code>ActivityDefinition.code</code> - Activity type code</li>
                            <li><code>ActivityDefinition.topic</code> - Clinical topic</li>
                            <li><code>ActivityDefinition.jurisdiction</code> - Jurisdiction</li>
                        </ul>
                    </div>
                    <div class="col-md-6">
                        <h6>ChargeItemDefinition</h6>
                        <ul class="list-unstyled small">
                            <li><code>ChargeItemDefinition.code</code> - Billing code</li>
                            <li><code>ChargeItemDefinition.jurisdiction</code> - Jurisdiction</li>
                        </ul>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- Add/Edit Binding Modal -->
@if (_showModal)
{
    <div class="modal fade show d-block" tabindex="-1" style="background-color: rgba(0,0,0,0.5);">
        <div class="modal-dialog modal-lg">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title">
                        @(_isEditing ? "Edit" : "Add") ValueSet Binding
                    </h5>
                    <button type="button" class="btn-close" @onclick="CloseModal"></button>
                </div>
                <div class="modal-body">
                    <div class="mb-3">
                        <label class="form-label fw-bold">Element Path <span class="text-danger">*</span></label>
                        <input type="text" class="form-control" placeholder="e.g., ActivityDefinition.code"
                               @bind="_modalElementPath" disabled="@_isEditing" />
                        <div class="form-text">
                            The FHIR element path this binding applies to (e.g., <code>ActivityDefinition.code</code>)
                        </div>
                    </div>

                    <div class="mb-3">
                        <label class="form-label fw-bold">ValueSet/CodeSystem URL <span class="text-danger">*</span></label>
                        <div class="input-group">
                            <input type="text" class="form-control" placeholder="http://..."
                                   @bind="_modalValueSetUrl" />
                            <button class="btn btn-outline-secondary dropdown-toggle" type="button"
                                    data-bs-toggle="dropdown" aria-expanded="false">
                                Browse
                            </button>
                            <ul class="dropdown-menu dropdown-menu-end" style="max-height: 300px; overflow-y: auto;">
                                @if (_availableValueSets.Any())
                                {
                                    <li><h6 class="dropdown-header">ValueSets</h6></li>
                                    @foreach (var vs in _availableValueSets.Take(15))
                                    {
                                        <li>
                                            <button class="dropdown-item small" type="button" 
                                                    @onclick="() => SelectValueSet(vs)">
                                                <span class="fw-bold">@(vs.Name ?? vs.Title ?? "Untitled")</span>
                                                <br />
                                                <small class="text-muted">@vs.Url</small>
                                            </button>
                                        </li>
                                    }
                                }
                                @if (_availableCodeSystems.Any())
                                {
                                    <li><hr class="dropdown-divider"></li>
                                    <li><h6 class="dropdown-header">CodeSystems</h6></li>
                                    @foreach (var cs in _availableCodeSystems.Take(15))
                                    {
                                        <li>
                                            <button class="dropdown-item small" type="button"
                                                    @onclick="() => SelectCodeSystem(cs)">
                                                <span class="fw-bold">@(cs.Name ?? cs.Title ?? "Untitled")</span>
                                                <br />
                                                <small class="text-muted">@cs.Url</small>
                                            </button>
                                        </li>
                                    }
                                }
                                @if (!_availableValueSets.Any() && !_availableCodeSystems.Any())
                                {
                                    <li>
                                        <span class="dropdown-item-text text-muted">
                                            No terminology resources found on server
                                        </span>
                                    </li>
                                }
                            </ul>
                        </div>
                        <div class="form-text">
                            The canonical URL of the ValueSet or CodeSystem to bind to this element
                        </div>
                    </div>

                    <div class="mb-3">
                        <label class="form-label fw-bold">Display Name (optional)</label>
                        <input type="text" class="form-control" placeholder="Friendly name for this binding"
                               @bind="_modalDisplayName" />
                        <div class="form-text">
                            Optional friendly name to display instead of the URL
                        </div>
                    </div>

                    @if (!string.IsNullOrEmpty(_modalValueSetUrl))
                    {
                        <div class="mt-3 p-3 bg-light rounded">
                            <h6>Preview Codes</h6>
                            @if (_previewLoading)
                            {
                                <div class="d-flex align-items-center gap-2">
                                    <div class="spinner-border spinner-border-sm" role="status"></div>
                                    <span class="text-muted">Loading codes...</span>
                                </div>
                            }
                            else if (_previewCodes.Any())
                            {
                                <div class="small" style="max-height: 150px; overflow-y: auto;">
                                    @foreach (var previewCode in _previewCodes.Take(20))
                                    {
                                        <div class="d-flex gap-2 py-1 border-bottom">
                                            <code class="text-nowrap">@(previewCode.Code)</code>
                                            <span>@(previewCode.Display)</span>
                                        </div>
                                    }
                                    @if (_previewCodes.Count > 20)
                                    {
                                        <div class="text-muted py-1">
                                            ... and @(_previewCodes.Count - 20) more codes
                                        </div>
                                    }
                                </div>
                            }
                            else
                            {
                                <div class="text-muted">
                                    <i class="bi bi-exclamation-triangle me-1"></i>
                                    No codes found. Check if the URL is correct.
                                </div>
                            }
                            <button class="btn btn-sm btn-outline-secondary mt-2" @onclick="LoadPreviewCodes">
                                <i class="bi bi-arrow-clockwise me-1"></i>Reload
                            </button>
                        </div>
                    }
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" @onclick="CloseModal">Cancel</button>
                    <button type="button" class="btn btn-primary" @onclick="SaveBinding"
                            disabled="@(string.IsNullOrWhiteSpace(_modalElementPath) || string.IsNullOrWhiteSpace(_modalValueSetUrl))">
                        <i class="bi bi-check-lg me-1"></i>Save Binding
                    </button>
                </div>
            </div>
        </div>
    </div>
}

@code {
    private IReadOnlyDictionary<string, ValueSetBindingConfig> _bindings = new Dictionary<string, ValueSetBindingConfig>();
    private Dictionary<string, int> _codeCounts = new();
    private HashSet<string> _codeCountsLoading = new();
    private bool _isLoading = true;

    private List<Hl7.Fhir.Model.ValueSet> _availableValueSets = new();
    private List<Hl7.Fhir.Model.CodeSystem> _availableCodeSystems = new();

    // Modal state
    private bool _showModal = false;
    private bool _isEditing = false;
    private string _modalElementPath = "";
    private string _modalValueSetUrl = "";
    private string _modalDisplayName = "";
    private List<BoundCode> _previewCodes = new();
    private bool _previewLoading = false;

    protected override async Task OnInitializedAsync()
    {
        await BindingService.InitializeAsync();
        LoadBindings();
        await LoadAvailableTerminology();
    }

    private void LoadBindings()
    {
        _isLoading = true;
        _bindings = BindingService.GetAllBindings();
        _isLoading = false;
    }

    private async Task LoadAvailableTerminology()
    {
        try
        {
            var vsBundle = await TerminologyService.SearchValueSetsAsync("");
            _availableValueSets = vsBundle.Entry?
                .Select(e => e.Resource as Hl7.Fhir.Model.ValueSet)
                .Where(vs => vs != null)
                .Cast<Hl7.Fhir.Model.ValueSet>()
                .ToList() ?? new();

            var csBundle = await TerminologyService.SearchCodeSystemsAsync("");
            _availableCodeSystems = csBundle.Entry?
                .Select(e => e.Resource as Hl7.Fhir.Model.CodeSystem)
                .Where(cs => cs != null)
                .Cast<Hl7.Fhir.Model.CodeSystem>()
                .ToList() ?? new();
        }
        catch
        {
            _availableValueSets = new();
            _availableCodeSystems = new();
        }
    }

    private async Task LoadCodeCount(string elementPath)
    {
        _codeCountsLoading.Add(elementPath);
        StateHasChanged();

        try
        {
            var codes = await BindingService.GetBoundCodesAsync(elementPath);
            _codeCounts[elementPath] = codes.Count;
        }
        catch
        {
            _codeCounts[elementPath] = 0;
        }

        _codeCountsLoading.Remove(elementPath);
        StateHasChanged();
    }

    private void ShowAddBindingModal()
    {
        _isEditing = false;
        _modalElementPath = "";
        _modalValueSetUrl = "";
        _modalDisplayName = "";
        _previewCodes = new();
        _showModal = true;
    }

    private void EditBinding(ValueSetBindingConfig binding)
    {
        _isEditing = true;
        _modalElementPath = binding.ElementPath;
        _modalValueSetUrl = binding.ValueSetUrl;
        _modalDisplayName = binding.DisplayName ?? "";
        _previewCodes = new();
        _showModal = true;
        _ = LoadPreviewCodes();
    }

    private void CloseModal()
    {
        _showModal = false;
    }

    private void SelectValueSet(Hl7.Fhir.Model.ValueSet vs)
    {
        _modalValueSetUrl = vs.Url ?? "";
        _modalDisplayName = vs.Name ?? vs.Title ?? "";
        _ = LoadPreviewCodes();
    }

    private void SelectCodeSystem(Hl7.Fhir.Model.CodeSystem cs)
    {
        _modalValueSetUrl = cs.Url ?? "";
        _modalDisplayName = cs.Name ?? cs.Title ?? "";
        _ = LoadPreviewCodes();
    }

    private async Task LoadPreviewCodes()
    {
        if (string.IsNullOrWhiteSpace(_modalValueSetUrl)) return;

        _previewLoading = true;
        StateHasChanged();

        try
        {
            _previewCodes = await BindingService.GetCodesFromValueSetAsync(_modalValueSetUrl);
        }
        catch
        {
            _previewCodes = new();
        }

        _previewLoading = false;
        StateHasChanged();
    }

    private async Task SaveBinding()
    {
        if (string.IsNullOrWhiteSpace(_modalElementPath) || string.IsNullOrWhiteSpace(_modalValueSetUrl))
            return;

        await BindingService.SetBindingAsync(
            _modalElementPath,
            _modalValueSetUrl,
            string.IsNullOrWhiteSpace(_modalDisplayName) ? null : _modalDisplayName
        );

        LoadBindings();
        _codeCounts.Remove(_modalElementPath); // Force reload of code count
        CloseModal();
    }

    private async Task DeleteBinding(string elementPath)
    {
        await BindingService.RemoveBindingAsync(elementPath);
        _codeCounts.Remove(elementPath);
        LoadBindings();
    }
}
