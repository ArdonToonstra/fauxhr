@page "/acp/creator"
@using FauxHR.Core.Services
@using FauxHR.Core.Interfaces
@using FauxHR.Modules.ExitStrategy.Helpers
@using Hl7.Fhir.Model
@using Task = System.Threading.Tasks.Task
@inject AppState AppState
@inject NavigationManager Navigation
@inject IFhirService FhirService

<PageTitle>ACP - Registreren</PageTitle>

<div class="container-fluid py-4">
    <!-- Header -->
    <div class="d-flex justify-content-between align-items-center mb-4">
        <div>
            <h2 class="display-6 fw-bold text-success mb-1">
                <i class="bi bi-plus-circle me-3"></i>Advance Care Planning - Registreren
            </h2>
            <p class="text-muted small mb-0">Registreer nieuw ACP-gesprek en wensen</p>
        </div>
        <div class="d-flex gap-2">
            <button class="btn btn-outline-secondary" @onclick='() => Navigation.NavigateTo("acp/viewer")'>
                <i class="bi bi-eye me-2"></i>Naar viewer
            </button>
            <button class="btn btn-outline-secondary" @onclick='() => Navigation.NavigateTo("acp/overview")'>
                <i class="bi bi-arrow-left me-2"></i>Terug
            </button>
        </div>
    </div>

    @if (AppState.CurrentPatient == null)
    {
        <div class="alert alert-warning">
            <i class="bi bi-exclamation-triangle me-2"></i>
            Geen patiënt geselecteerd. Selecteer eerst een patiënt op het Dashboard.
        </div>
    }
    else
    {
        <!-- Patient Info Card -->
        <div class="card border-0 shadow-sm mb-4 bg-light">
            <div class="card-body p-3">
                <div class="d-flex align-items-center">
                    <div class="bg-primary-subtle text-primary rounded-circle p-2 me-3">
                        <i class="bi bi-person-vcard fs-5"></i>
                    </div>
                    <div>
                        <strong>Patiënt:</strong> @patientName
                        <span class="badge bg-info ms-2">@(AppState.CurrentPatient.Id)</span>
                    </div>
                </div>
            </div>
        </div>

        <!-- Tab Navigation -->
        <ul class="nav nav-tabs mb-4" role="tablist">
            <li class="nav-item" role="presentation">
                <button class="nav-link @(activeTab == "encounter" ? "active" : "")" 
                        @onclick='() => activeTab = "encounter"'>
                    <i class="bi bi-chat-dots me-2"></i>ACP Gesprek
                </button>
            </li>
            <li class="nav-item" role="presentation">
                <button class="nav-link @(activeTab == "goal" ? "active" : "")" 
                        @onclick='() => activeTab = "goal"'>
                    <i class="bi bi-flag me-2"></i>Behandeldoel
                </button>
            </li>
            <li class="nav-item" role="presentation">
                <button class="nav-link @(activeTab == "consent" ? "active" : "")" 
                        @onclick='() => activeTab = "consent"'>
                    <i class="bi bi-clipboard-check me-2"></i>Behandelwens
                </button>
            </li>
            <li class="nav-item" role="presentation">
                <button class="nav-link @(activeTab == "observation" ? "active" : "")" 
                        @onclick='() => activeTab = "observation"'>
                    <i class="bi bi-clipboard-data me-2"></i>Bevinding
                </button>
            </li>
        </ul>

        <!-- Tab Content -->
        <div class="tab-content">
            @if (activeTab == "encounter")
            {
                <div class="card border-0 shadow-sm">
                    <div class="card-body p-4">
                        <h5 class="card-title mb-4">
                            <i class="bi bi-chat-dots text-primary me-2"></i>
                            Nieuw ACP Gesprek Registreren
                        </h5>
                        
                        <form>
                            <div class="row g-3">
                                <div class="col-md-6">
                                    <label class="form-label fw-bold">Datum gesprek *</label>
                                    <input type="date" class="form-control" @bind="encounterDate" />
                                </div>
                                <div class="col-12">
                                    <label class="form-label fw-bold">Deelnemers</label>
                                    
                                     <!-- Participant List -->
                                    <div class="list-group mb-3">
                                        @foreach (var participant in participants)
                                        {
                                            <div class="list-group-item d-flex justify-content-between align-items-center">
                                                <div>
                                                    <i class="bi @GetParticipantIcon(participant.Resource) me-2"></i>
                                                    @GetParticipantName(participant.Resource)
                                                    <span class="badge bg-secondary ms-2 small">@participant.Resource.TypeName</span>
                                                </div>
                                                @if (participant.Resource != AppState.CurrentPatient && participant.Resource != AppState.CurrentPractitioner)
                                                {
                                                     <button type="button" class="btn btn-sm btn-outline-danger border-0" @onclick="() => RemoveParticipant(participant)">
                                                        <i class="bi bi-trash"></i>
                                                    </button>
                                                }
                                            </div>
                                        }
                                    </div>
                                    
                                    <!-- Add Participant -->
                                    <div class="card bg-light border-0 p-3">
                                        <h6 class="text-muted small fw-bold mb-2">Deelnemer toevoegen</h6>
                                         <div class="input-group mb-2">
                                            <select class="form-select" @bind="participantTypeToAdd">
                                                <option value="Practitioner">Zorgverlener (Practitioner)</option>
                                                <option value="RelatedPerson">Naaste (RelatedPerson)</option>
                                            </select>
                                            <input type="text" class="form-control" @bind="participantSearchQuery" @bind:event="oninput" @onkeyup="SearchParticipant" placeholder="Zoek op naam..." />
                                            <button class="btn btn-outline-primary" type="button" @onclick="ExecuteParticipantSearch">
                                                <i class="bi bi-search"></i>
                                            </button>
                                        </div>
                                        
                                        <!-- Search Results -->
                                        @if (foundParamParticipants != null && foundParamParticipants.Any())
                                        {
                                            <div class="list-group">
                                                @foreach (var p in foundParamParticipants)
                                                {
                                                    <button type="button" class="list-group-item list-group-item-action d-flex justify-content-between align-items-center" @onclick="() => SelectParticipant(p)">
                                                        <span>@GetParticipantName(p)</span>
                                                        <i class="bi bi-plus-circle text-success"></i>
                                                    </button>
                                                }
                                            </div>
                                        }
                                        else if (isSearchingParticipants)
                                        {
                                             <div class="text-center py-2 text-muted small">
                                                <div class="spinner-border spinner-border-sm me-1"></div> Zoeken...
                                            </div>
                                        }
                                        else if (searchPerformed && (foundParamParticipants == null || !foundParamParticipants.Any()))
                                        {
                                             <div class="text-center py-2 text-muted small">
                                                Geen resultaten gevonden.
                                            </div>
                                        }
                                    </div>
                                    
                                </div>
                            </div>

                            <div class="d-flex gap-2 mt-4">
                                <button type="button" class="btn btn-primary" @onclick="SaveEncounterLocal">
                                    Volgende <i class="bi bi-arrow-right ms-2"></i>
                                </button>
                            </div>
                        </form>
                    </div>
                </div>
            }
            else if (activeTab == "goal")
            {
                <div class="card border-0 shadow-sm">
                    <div class="card-body p-4">
                        <h5 class="card-title mb-4">
                            <i class="bi bi-flag text-primary me-2"></i>
                            Behandeldoel Registreren
                        </h5>
                        <form>
                            <div class="row g-3">
                                <div class="col-12">
                                    <label class="form-label fw-bold">Behandeldoel *</label>
                                    <select class="form-select" @bind="goalCode">
                                        <option value="">-- Selecteer behandeldoel --</option>
                                        <option value="385987000">Genezen (Cure)</option>
                                        <option value="1351964001">Levensverlenging (Life-prolonging)</option>
                                        <option value="713148004">Palliatief (Palliation)</option>
                                    </select>
                                </div>
                                <div class="col-md-6">
                                    <label class="form-label fw-bold">Status</label>
                                    <select class="form-select" @bind="goalStatus">
                                        <option value="active">Actief</option>
                                        <option value="completed">Voltooid</option>
                                        <option value="cancelled">Geannuleerd</option>
                                    </select>
                                </div>
                                 <div class="col-md-6">
                                    <label class="form-label fw-bold">Datum</label>
                                    <input type="date" class="form-control" @bind="goalDate" />
                                </div>
                                <div class="col-12">
                                    <label class="form-label fw-bold">Toelichting</label>
                                    <textarea class="form-control" rows="3" @bind="goalNotes" placeholder="Eventuele toelichting..."></textarea>
                                </div>
                            </div>

                            <div class="d-flex gap-2 mt-4">
                                <button type="button" class="btn btn-primary" @onclick='() => activeTab = "consent"'>
                                     Volgende <i class="bi bi-arrow-right ms-2"></i>
                                </button>
                            </div>
                        </form>
                    </div>
                </div>
            }
             else if (activeTab == "consent")
            {
                 <div class="card border-0 shadow-sm">
                    <div class="card-body p-4">
                         <h5 class="card-title mb-4">
                            <i class="bi bi-clipboard-check text-primary me-2"></i>
                            Behandelwens Registreren
                        </h5>
                        <form>
                            <div class="row g-3">
                                <div class="col-12">
                                    <label class="form-label fw-bold">Type behandeling *</label>
                                    <select class="form-select" @bind="consentTreatmentType">
                                        <option value="">-- Selecteer behandeling --</option>
                                        <option value="reanimation">Reanimatie</option>
                                        <option value="artificial-respiration">Kunstmatige beademing</option>
                                        <option value="artificial-nutrition">Kunstmatige voeding</option>
                                        <option value="icu-admission">IC-opname</option>
                                        <option value="other">Anders</option>
                                    </select>
                                </div>
                                <div class="col-md-6">
                                    <label class="form-label fw-bold">Besluit *</label>
                                    <select class="form-select" @bind="consentDecision">
                                        <option value="permit">Wel uitvoeren</option>
                                        <option value="deny">Niet uitvoeren</option>
                                    </select>
                                </div>
                                <div class="col-md-6">
                                    <label class="form-label fw-bold">Datum</label>
                                    <input type="date" class="form-control" @bind="consentDate" />
                                </div>
                                @if (consentTreatmentType == "other")
                                {
                                    <div class="col-12">
                                        <label class="form-label fw-bold">Specificatie</label>
                                        <input type="text" class="form-control" @bind="consentOtherSpecification" placeholder="Specificeer de behandeling..." />
                                    </div>
                                }
                                <div class="col-12">
                                    <label class="form-label fw-bold">Toelichting</label>
                                    <textarea class="form-control" rows="3" @bind="consentNotes" placeholder="Eventuele toelichting..."></textarea>
                                </div>
                            </div>
                            <div class="d-flex gap-2 mt-4">
                                <button type="button" class="btn btn-primary" @onclick='() => activeTab = "observation"'>
                                     Volgende <i class="bi bi-arrow-right ms-2"></i>
                                </button>
                            </div>
                        </form>
                    </div>
                 </div>
            }
             else if (activeTab == "observation")
            {
                <div class="card border-0 shadow-sm">
                    <div class="card-body p-4">
                         <h5 class="card-title mb-4">
                            <i class="bi bi-clipboard-data text-primary me-2"></i>
                            Bevinding Registreren
                        </h5>
                        <form>
                             <div class="row g-3">
                                <div class="col-12">
                                    <label class="form-label fw-bold">Type bevinding *</label>
                                    <select class="form-select" @bind="observationType">
                                        <option value="">-- Selecteer type --</option>
                                        <option value="153851000146100">Wilsbekwaamheid medische beslissingen</option>
                                        <option value="395091006">Communicatiebeperkingen</option>
                                        <option value="340171000146104">Levensoverwegingen</option>
                                        <option value="247751003">Zorgen/angsten</option>
                                    </select>
                                </div>
                                <div class="col-md-6">
                                    <label class="form-label fw-bold">Waarde</label>
                                    <input type="text" class="form-control" @bind="observationValue" placeholder="Waarde of omschrijving..." />
                                </div>
                                <div class="col-md-6">
                                    <label class="form-label fw-bold">Datum</label>
                                    <input type="date" class="form-control" @bind="observationDate" />
                                </div>
                                <div class="col-12">
                                    <label class="form-label fw-bold">Notities</label>
                                    <textarea class="form-control" rows="3" @bind="observationNotes" placeholder="Aanvullende notities..."></textarea>
                                </div>
                            </div>
                            <div class="d-flex gap-2 mt-4">
                                <button type="button" class="btn btn-success" @onclick="SaveAll">
                                     <i class="bi bi-check-circle me-2"></i>Afronden &amp Opslaan
                                </button>
                            </div>
                        </form>
                    </div>
                </div>
            }
        </div>

        <!-- Success Message -->
        @if (showSuccessMessage)
        {
            <div class="alert alert-success alert-dismissible fade show mt-4" role="alert">
                <i class="bi bi-check-circle me-2"></i>
                <strong>Opgeslagen!</strong> De gegevens zijn in het geheugen opgeslagen (Transaction Bundle voorbereid).
                <button type="button" class="btn-close" @onclick="() => showSuccessMessage = false"></button>
            </div>
        }
    }
</div>

@code {
    private string patientName = "Unknown";
    private string activeTab = "encounter";
    private bool showSuccessMessage = false;

    // Local Memory Store for "Transaction Bundle"
    private List<Resource> transactionBundleResources = new();

    // Encounter fields
    private DateTime encounterDate = DateTime.Today;
    
    // Participant Management
    private List<AcpParticipant> participants = new();
    private string participantTypeToAdd = "Practitioner";
    private string participantSearchQuery = "";
    private bool isSearchingParticipants = false;
    private bool searchPerformed = false;
    private List<Resource> foundParamParticipants = new(); /* Practitioner or RelatedPerson */

    private class AcpParticipant
    {
        public Resource Resource { get; set; } = default!;
        // Could add specific role if needed
    }

    // Goal fields
    private string goalCode = "";
    private string goalStatus = "active";
    private DateTime goalDate = DateTime.Today;
    private string goalNotes = "";

    // Consent fields
    private string consentTreatmentType = "";
    private string consentDecision = "permit";
    private DateTime consentDate = DateTime.Today;
    private string consentOtherSpecification = "";
    private string consentNotes = "";

    // Observation fields
    private string observationType = "";
    private string observationValue = "";
    private DateTime observationDate = DateTime.Today;
    private string observationNotes = "";

    protected override void OnInitialized()
    {
        if (AppState.CurrentPatient != null)
        {
            patientName = PatientHelper.GetPatientName(AppState.CurrentPatient);
            
            // Add Patient as Subject/Participant context implicitly for display
             participants.Add(new AcpParticipant { Resource = AppState.CurrentPatient });
        }
        
        if (AppState.CurrentPractitioner != null)
        {
            participants.Add(new AcpParticipant { Resource = AppState.CurrentPractitioner });
        }
    }

    private string GetParticipantName(Resource r)
    {
        if (r is Patient p) return PatientHelper.GetPatientName(p);
        if (r is Practitioner prac)
        {
             if (prac.Name?.FirstOrDefault() is HumanName name)
            {
                var prefix = name.Prefix.Any() ? string.Join(" ", name.Prefix) + " " : "";
                var given = string.Join(" ", name.Given ?? Array.Empty<string>());
                return $"{prefix}{given} {name.Family}".Trim();
            }
            return "Unknown Practitioner";
        }
        if (r is RelatedPerson rp)
        {
             if (rp.Name?.FirstOrDefault() is HumanName name)
            {
                return $"{string.Join(" ", name.Given ?? Array.Empty<string>())} {name.Family}".Trim();
            }
            return "Unknown RelatedPerson";
        }
        return "Unknown";
    }

    private string GetParticipantIcon(Resource r)
    {
        return r switch
        {
            Patient => "bi-person-vcard",
            Practitioner => "bi-person-badge-fill",
            RelatedPerson => "bi-heart-fill",
            _ => "bi-person"
        };
    }
    
    // Search Participants
    private async Task KeyUp(KeyboardEventArgs e)
    {
        if (e.Key == "Enter") await ExecuteParticipantSearch();
    }
    
    private async Task SearchParticipant(KeyboardEventArgs e) {
        if (e.Key == "Enter")
        {
             await ExecuteParticipantSearch();
        }
    }

    private async Task ExecuteParticipantSearch()
    {
        if (string.IsNullOrWhiteSpace(participantSearchQuery)) return;
        
        isSearchingParticipants = true;
        searchPerformed = true;
        foundParamParticipants.Clear();
        
        try
        {
            if (participantTypeToAdd == "Practitioner")
            {
                var bundle = await FhirService.SearchPractitionersAsync(participantSearchQuery);
                 if (bundle.Entry != null)
                {
                    foundParamParticipants.AddRange(bundle.Entry.Select(e => e.Resource).OfType<Practitioner>());
                }
            }
            else if (participantTypeToAdd == "RelatedPerson")
            {
                var bundle = await FhirService.SearchRelatedPersonsAsync(participantSearchQuery);
                if (bundle.Entry != null)
                {
                    foundParamParticipants.AddRange(bundle.Entry.Select(e => e.Resource).OfType<RelatedPerson>());
                }
            }
        }
        finally
        {
            isSearchingParticipants = false;
        }
    }

    private void SelectParticipant(Resource r)
    {
        if (!participants.Any(p => p.Resource.Id == r.Id))
        {
            participants.Add(new AcpParticipant { Resource = r });
        }
        // Reset search
        participantSearchQuery = "";
        foundParamParticipants.Clear();
        searchPerformed = false;
    }

    private void RemoveParticipant(AcpParticipant p)
    {
        participants.Remove(p);
    }

    private void SaveEncounterLocal()
    {
        // Create Encounter Resource
        var encounter = new Encounter();
        encounter.Id = Guid.NewGuid().ToString();
        
        // Identifier
        encounter.Identifier.Add(new Identifier
        {
            System = "https://fauxhr.fhir/namingsystem/resource-identifier",
            Value = Guid.NewGuid().ToString()
        });

        // Status & Class
        encounter.Status = Encounter.EncounterStatus.Finished;
        encounter.Class = new Coding("http://terminology.hl7.org/CodeSystem/v3-ActCode", "IMP", "inpatient encounter");
        
        // Subject -> Patient
        if (AppState.CurrentPatient != null)
        {
            encounter.Subject = new ResourceReference($"Patient/{AppState.CurrentPatient.Id}");
        }

        // Period (Date)
        encounter.Period = new Period { StartElement = new FhirDateTime(encounterDate), EndElement = new FhirDateTime(encounterDate) };

        // Participants
        foreach (var p in participants)
        {
             // Skip Patient in participant list as they are Subject
             if (p.Resource is not Patient)
             {
                 var fhirParticipant = new Encounter.ParticipantComponent();
                 string refStr = $"{p.Resource.TypeName}/{p.Resource.Id}";
                 fhirParticipant.Individual = new ResourceReference(refStr);
                 encounter.Participant.Add(fhirParticipant);
             }
        }
        
        // Add to local transaction bundle
        transactionBundleResources.Add(encounter);
        
        Console.WriteLine($"[Local] Encounter Created: {encounter.Id}");
        
        // Move to next tab
        activeTab = "goal";
    }

    private void SaveAll()
    {
        // TODO: Create other resources (Goal, Consent, etc) similar to Encounter logic
        // For now, just show success
        showSuccessMessage = true;
    }
}
