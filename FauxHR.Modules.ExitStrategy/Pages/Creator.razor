@page "/acp/creator"
@using FauxHR.Core.Services
@using FauxHR.Core.Interfaces
@using FauxHR.Modules.ExitStrategy.Helpers
@using Hl7.Fhir.Model
@using Hl7.Fhir.Serialization
@using Task = System.Threading.Tasks.Task
@inject AppState AppState
@inject NavigationManager Navigation
@inject IFhirService FhirService

<PageTitle>ACP - Registreren</PageTitle>

<div class="container-fluid py-4">
    <!-- Header -->
    <div class="d-flex justify-content-between align-items-center mb-4">
        <div>
            <h2 class="display-6 fw-bold text-success mb-1">
                <i class="bi bi-plus-circle me-3"></i>Advance Care Planning - Registreren
            </h2>
            <p class="text-muted small mb-0">Registreer nieuw ACP-gesprek en wensen</p>
        </div>
        <div class="d-flex gap-2">
            <button class="btn btn-outline-secondary" @onclick='() => Navigation.NavigateTo("acp/viewer")'>
                <i class="bi bi-eye me-2"></i>Naar viewer
            </button>
            <button class="btn btn-outline-secondary" @onclick='() => Navigation.NavigateTo("acp/overview")'>
                <i class="bi bi-arrow-left me-2"></i>Terug
            </button>
        </div>
    </div>

    @if (AppState.CurrentPatient == null)
    {
        <div class="alert alert-warning">
            <i class="bi bi-exclamation-triangle me-2"></i>
            Geen patiënt geselecteerd. Selecteer eerst een patiënt op het Dashboard.
        </div>
    }
    else
    {
        <!-- Patient Info Card -->
        <div class="card border-0 shadow-sm mb-4 bg-light">
            <div class="card-body p-3">
                <div class="d-flex align-items-center">
                    <div class="bg-primary-subtle text-primary rounded-circle p-2 me-3">
                        <i class="bi bi-person-vcard fs-5"></i>
                    </div>
                    <div>
                        <strong>Patiënt:</strong> @patientName
                        <span class="badge bg-info ms-2">@(AppState.CurrentPatient.Id)</span>
                    </div>
                </div>
            </div>
        </div>

        <!-- Tab Navigation -->
        <ul class="nav nav-tabs mb-4" role="tablist">
            <li class="nav-item" role="presentation">
                <button class="nav-link @(activeTab == "encounter" ? "active" : "")" 
                        @onclick='() => activeTab = "encounter"'>
                    <i class="bi bi-chat-dots me-2"></i>ACP Gesprek
                </button>
            </li>
            <li class="nav-item" role="presentation">
                <button class="nav-link @(activeTab == "goal" ? "active" : "")" 
                        @onclick='() => activeTab = "goal"'>
                    <i class="bi bi-flag me-2"></i>Behandeldoel
                </button>
            </li>
            <li class="nav-item" role="presentation">
                <button class="nav-link @(activeTab == "consent" ? "active" : "")" 
                        @onclick='() => activeTab = "consent"'>
                    <i class="bi bi-clipboard-check me-2"></i>Behandelaanwijzingen
                </button>
            </li>
            <li class="nav-item" role="presentation">
                <button class="nav-link @(activeTab == "observation" ? "active" : "")" 
                        @onclick='() => activeTab = "observation"'>
                    <i class="bi bi-clipboard-data me-2"></i>Bevindingen & Wensen
                </button>
            </li>
        </ul>

        <!-- Tab Content -->
        <div class="tab-content">
            @if (activeTab == "encounter")
            {
                <div class="card border-0 shadow-sm">
                    <div class="card-body p-4">
                        <h5 class="card-title mb-4">
                            <i class="bi bi-chat-dots text-primary me-2"></i>
                            Nieuw ACP Gesprek Registreren
                        </h5>
                        
                        <form>
                            <div class="row g-3">
                                <div class="col-md-6">
                                    <label class="form-label fw-bold">Datum gesprek *</label>
                                    <input type="date" class="form-control" @bind="encounterDate" />
                                </div>
                                <div class="col-md-6">
                                    <div class="alert alert-light border mb-0">
                                        <small class="text-muted"><i class="bi bi-info-circle me-1"></i>Het ID van dit gesprek wordt gekoppeld aan alle volgende registraties.</small>
                                    </div>
                                </div>

                                <div class="col-12">
                                     <label class="form-label fw-bold">Deelnemers</label>
                                     
                                     <div class="d-flex mb-2 gap-2">
                                         <select class="form-select" style="width: auto;" @bind="participantTypeToAdd">
                                             <option value="Practitioner">Zorgverlener</option>
                                             <option value="RelatedPerson">Contactpersoon</option>
                                         </select>
                                         <div class="input-group">
                                             <input type="text" class="form-control" 
                                                    placeholder="Zoek naam..." 
                                                    @bind="participantSearchQuery" 
                                                    @bind:event="oninput"
                                                    @onkeyup="KeyUp" />
                                             <button class="btn btn-outline-secondary" type="button" @onclick="ExecuteParticipantSearch">
                                                 <i class="bi bi-search"></i>
                                             </button>
                                         </div>
                                     </div>
                                     
                                     @if (isSearchingParticipants)
                                     {
                                         <div class="text-muted small my-2"><span class="spinner-border spinner-border-sm me-2"></span>Zoeken...</div>
                                     }
                                     
                                     @if (!isSearchingParticipants && searchPerformed && !foundParamParticipants.Any())
                                     {
                                         <div class="text-muted small my-2">Geen resultaten gevonden.</div>
                                     }

                                     @if (foundParamParticipants.Any())
                                     {
                                         <div class="list-group mb-3">
                                             @foreach (var r in foundParamParticipants)
                                             {
                                                 <button type="button" class="list-group-item list-group-item-action d-flex justify-content-between align-items-center" @onclick="() => SelectParticipant(r)">
                                                     <div>
                                                         @if (r is Practitioner prac)
                                                         {
                                                             <strong>@GetParticipantName(r)</strong> <span class="text-muted small ms-2">@prac.Id</span>
                                                         }
                                                         else if (r is RelatedPerson rel)
                                                         {
                                                              <strong>@GetParticipantName(r)</strong> <span class="text-muted small ms-2">@rel.Relationship?.FirstOrDefault()?.Coding?.FirstOrDefault()?.Display ?? "Relatie"</span>
                                                         }
                                                     </div>
                                                     <i class="bi bi-plus-lg"></i>
                                                 </button>
                                             }
                                         </div>
                                     }

                                     <div class="mt-2">
                                         @foreach (var p in participants)
                                         {
                                             <span class="badge bg-light text-dark border me-1 mb-1 p-2">
                                                 <i class="bi bi-person me-1"></i> @GetParticipantName(p.Resource)
                                                 @if (p.Resource is not Patient)
                                                 {
                                                     <i class="bi bi-x-circle ms-2 cursor-pointer text-danger" @onclick="() => RemoveParticipant(p)" style="cursor: pointer;"></i>
                                                 }
                                             </span>
                                         }
                                     </div>
                                </div>
                            </div>
                            <div class="d-flex gap-2 mt-4">
                                <button type="button" class="btn btn-primary" @onclick="SaveEncounterLocal">
                                     Volgende <i class="bi bi-arrow-right ms-2"></i>
                                </button>
                            </div>
                        </form>
                    </div>
                </div>
            }
            else if (activeTab == "goal")
            {
               <div class="card border-0 shadow-sm">
                    <div class="card-body p-4">
                        <h5 class="card-title mb-4">
                            <i class="bi bi-flag text-primary me-2"></i>
                            Behandeldoel Registreren
                        </h5>
                        <form>
                            <div class="row g-3">
                                <div class="col-12">
                                    <label class="form-label fw-bold">Behandeldoel *</label>
                                    <select class="form-select" @bind="goalCode">
                                        <option value="">-- Selecteer doel --</option>
                                        <option value="385987000">zorg bij ziekte en/of letsel</option>
                                        <option value="1351964001">levensverlengende behandeling</option>
                                        <option value="713148004">voorkomen en behandelen van symptomen</option>
                                    </select>
                                </div>
                                <div class="col-md-6">
                                    <label class="form-label fw-bold">Ingangsdatum doel</label>
                                    <input type="date" class="form-control" @bind="goalDate" />
                                </div>
                                <div class="col-12">
                                    <label class="form-label fw-bold">Notities</label>
                                    <textarea class="form-control" rows="3" @bind="goalNotes" placeholder="Aanvullende notities..."></textarea>
                                </div>
                            </div>
                             <div class="d-flex gap-2 mt-4">
                                <button type="button" class="btn btn-primary" @onclick="SaveGoalLocal">
                                     Volgende <i class="bi bi-arrow-right ms-2"></i>
                                </button>
                            </div>
                        </form>
                    </div>
                </div>
            }
             else if (activeTab == "consent")
            {
                 <div class="card border-0 shadow-sm">
                    <div class="card-body p-4">
                         <h5 class="card-title mb-4">
                            <i class="bi bi-clipboard-check text-primary me-2"></i>
                            Behandelaanwijzingen Registreren
                        </h5>
                        
                        @* List of saved consents *@
                        @if (savedConsents.Any())
                        {
                            <div class="alert alert-info">
                                <h6 class="alert-heading"><i class="bi bi-list-ul me-2"></i>Geregistreerde behandelaanwijzingen (@savedConsents.Count)</h6>
                                <ul class="mb-0">
                                    @foreach (var consent in savedConsents)
                                    {
                                        <li>
                                            @GetConsentDisplay(consent)
                                            <button type="button" class="btn btn-sm btn-outline-danger ms-2" @onclick="() => RemoveConsent(consent)">
                                                <i class="bi bi-trash"></i>
                                            </button>
                                        </li>
                                    }
                                </ul>
                            </div>
                        }
                        
                        <form>
                            <div class="row g-3">
                                <div class="col-12">
                                    <label class="form-label fw-bold">Type behandeling *</label>
                                    <select class="form-select" @bind="consentTreatmentType">
                                        <option value="">-- Selecteer behandeling --</option>
                                        <option value="305351004">opname op intensive care</option>
                                        <option value="89666000">cardiopulmonale resuscitatie</option>
                                        <option value="40617009">kunstmatige beademing</option>
                                        <option value="116762002">toediening van bloedproduct</option>
                                        <option value="281789004">antibiotische therapie</option>
                                        <option value="32485007">opname in ziekenhuis</option>
                                        <option value="OTH">Anders</option>
                                    </select>
                                </div>
                                @if (consentTreatmentType == "OTH")
                                {
                                    <div class="col-12">
                                        <label class="form-label fw-bold">Specificatie behandeling *</label>
                                        <input type="text" class="form-control" @bind="consentOtherSpecification" placeholder="Specificeer de behandeling..." />
                                    </div>
                                }
                                <div class="col-12">
                                    <label class="form-label fw-bold">Besluit *</label>
                                    <select class="form-select" @bind="consentDecision">
                                        <option value="permit">Wel uitvoeren</option>
                                        <option value="deny">Niet uitvoeren</option>
                                        <option value="other">Anders</option>
                                    </select>
                                </div>
                                @if (consentDecision == "other")
                                {
                                    <div class="col-12">
                                        <label class="form-label fw-bold">Specificatie besluit *</label>
                                        <input type="text" class="form-control" @bind="consentDecisionOther" placeholder="Specificeer het besluit..." />
                                    </div>
                                }
                                <div class="col-12">
                                    <label class="form-label fw-bold">Toelichting</label>
                                    <textarea class="form-control" rows="3" @bind="consentNotes" placeholder="Eventuele toelichting..."></textarea>
                                </div>
                            </div>
                            <div class="d-flex gap-2 mt-4">
                                <button type="button" class="btn btn-success" @onclick="SaveConsentAndAddAnother">
                                     <i class="bi bi-plus-circle me-2"></i>Toevoegen
                                </button>
                                <button type="button" class="btn btn-primary" @onclick="ProceedToObservation">
                                     Volgende <i class="bi bi-arrow-right ms-2"></i>
                                </button>
                            </div>
                        </form>
                    </div>
                 </div>
            }
             else if (activeTab == "observation")
            {
                <div class="card border-0 shadow-sm">
                    <div class="card-body p-4">
                         <h5 class="card-title mb-4">
                            <i class="bi bi-clipboard-data text-primary me-2"></i>
                            Bevindingen & Wensen Registreren
                        </h5>
                        <form>
                             <div class="row g-3">
                                <div class="col-12">
                                    <label class="form-label fw-bold">Wensen en verwachtingen behandeling</label>
                                    <textarea class="form-control" rows="3" @bind="obsWishes" placeholder="Beschrijf wensen en verwachtingen..."></textarea>
                                </div>
                                <div class="col-md-6">
                                    <label class="form-label fw-bold">Voorkeursplaats van overlijden</label>
                                    <select class="form-select" @bind="obsPlaceOfDeath">
                                        <option value="">-- Selecteer plaats --</option>
                                        <option value="264362003">Thuis</option>
                                        <option value="22232009">Ziekenhuis</option>
                                        <option value="108344006">Verpleeghuis / ambulante zorg</option>
                                        <option value="284546000">Hospice</option>
                                        <option value="OTH">Anders</option>
                                        <option value="UNK">Nog onbekend</option>
                                    </select>
                                </div>
                                <div class="col-md-6">
                                    <label class="form-label fw-bold">Standpunt euthanasie</label>
                                    <select class="form-select" @bind="obsEuthanasia">
                                        <option value="">-- Selecteer standpunt --</option>
                                        <option value="340181000146102">Heeft euthanasieverklaring</option>
                                        <option value="340201000146103">Wil geen euthanasie</option>
                                        <option value="340191000146100">Heeft geen euthanasieverklaring</option>
                                        <option value="UNK">Nog onbekend</option>
                                    </select>
                                </div>
                                <div class="col-md-6">
                                    <label class="form-label fw-bold">Geregistreerd in orgaan donorregister</label>
                                    <select class="form-select" @bind="obsOrganDonation">
                                        <option value="">-- Selecteer status --</option>
                                        <option value="373066001">Ja</option>
                                        <option value="373067005">Nee</option>
                                        <option value="UNK">Nog onbekend</option>
                                    </select>
                                </div>
                            </div>
                            <div class="d-flex gap-2 mt-4">
                                <button type="button" class="btn btn-success" @onclick="SaveAll">
                                     <i class="bi bi-check-circle me-2"></i>Afronden &amp Opslaan
                                </button>
                            </div>
                        </form>
                    </div>
                </div>
            }
        </div>

        <!-- Success Message -->
        @if (showSuccessMessage)
        {
            <div class="alert alert-success alert-dismissible fade show mt-4" role="alert">
                <i class="bi bi-check-circle me-2"></i>
                <strong>Opgeslagen!</strong> De gegevens zijn in het geheugen opgeslagen (Transaction Bundle voorbereid).
                <button type="button" class="btn-close" @onclick="() => showSuccessMessage = false"></button>
            </div>
        }
    }

    @if (showDebugModal)
    {
        <div class="modal fade show d-block" style="background-color: rgba(0,0,0,0.5);">
            <div class="modal-dialog modal-xl modal-dialog-scrollable">
                <div class="modal-content">
                    <div class="modal-header bg-dark text-white">
                        <h5 class="modal-title"><i class="bi bi-bug me-2"></i>Debug: Transaction Bundle</h5>
                        <button type="button" class="btn-close btn-close-white" @onclick="CancelSend"></button>
                    </div>
                    <div class="modal-body bg-light">
                        <pre style="max-height: 500px; overflow: auto; background-color: #f8f9fa; padding: 15px; border-radius: 5px; font-size: 0.85em;"><code>@debugBundleJson</code></pre>
                    </div>
                    <div class="modal-footer">
                        <button type="button" class="btn btn-secondary" @onclick="CancelSend">Annuleren</button>
                        <button type="button" class="btn btn-success" @onclick="ConfirmSend">
                            <i class="bi bi-send me-2"></i>Versturen naar Server
                        </button>
                    </div>
                </div>
            </div>
        </div>
    }
</div>

@code {
    private string patientName = "Unknown";
    private string activeTab = "encounter";
    private bool showSuccessMessage = false;
    private bool showDebugModal = false;
    private string? debugBundleJson;
    private Bundle? preparedBundle;

    // Local Memory Store for "Transaction Bundle"
    private List<Resource> transactionBundleResources = new();

    // Encounter fields
    private DateTime encounterDate = DateTime.Today;
    
    // Participant Management
    private List<AcpParticipant> participants = new();
    private string participantTypeToAdd = "Practitioner";
    private string participantSearchQuery = "";
    private bool isSearchingParticipants = false;
    private bool searchPerformed = false;
    private List<Resource> foundParamParticipants = new(); /* Practitioner or RelatedPerson */

    private class AcpParticipant
    {
        public Resource Resource { get; set; } = default!;
        // Could add specific role if needed
    }

    // Goal fields
    private string goalCode = "";
    private string goalStatus = "active";
    private DateTime goalDate = DateTime.Today;
    private string goalNotes = "";

    // Consent fields
    private string consentTreatmentType = "";
    private string consentDecision = "permit";
    private string consentDecisionOther = "";
    private DateTime consentDate = DateTime.Today;
    private string consentOtherSpecification = "";
    private string consentNotes = "";
    private List<Consent> savedConsents = new();

    // Observation fields
    private string obsWishes = "";
    private string obsPlaceOfDeath = "";
    private string obsEuthanasia = "";
    private string obsOrganDonation = "";
    
    // Internal State
    private string currentEncounterId = "";
    private DateTime observationDate = DateTime.Today;
    private string observationNotes = "";

    protected override void OnInitialized()
    {
        if (AppState.CurrentPatient != null)
        {
            patientName = PatientHelper.GetPatientName(AppState.CurrentPatient);
            
            // Add Patient as Subject/Participant context implicitly for display
             participants.Add(new AcpParticipant { Resource = AppState.CurrentPatient });
        }
        
        if (AppState.CurrentPractitioner != null)
        {
            participants.Add(new AcpParticipant { Resource = AppState.CurrentPractitioner });
        }
    }

    private string GetParticipantName(Resource r)
    {
        if (r is Patient p) return PatientHelper.GetPatientName(p);
        if (r is Practitioner prac)
        {
             if (prac.Name?.FirstOrDefault() is HumanName name)
            {
                var prefix = name.Prefix.Any() ? string.Join(" ", name.Prefix) + " " : "";
                var given = string.Join(" ", name.Given ?? Array.Empty<string>());
                return $"{prefix}{given} {name.Family}".Trim();
            }
            return "Unknown Practitioner";
        }
        if (r is RelatedPerson rp)
        {
             if (rp.Name?.FirstOrDefault() is HumanName name)
            {
                return $"{string.Join(" ", name.Given ?? Array.Empty<string>())} {name.Family}".Trim();
            }
            return "Unknown RelatedPerson";
        }
        return "Unknown";
    }

    private string GetParticipantIcon(Resource r)
    {
        return r switch
        {
            Patient => "bi-person-vcard",
            Practitioner => "bi-person-badge-fill",
            RelatedPerson => "bi-heart-fill",
            _ => "bi-person"
        };
    }
    
    // Search Participants
    private async Task KeyUp(KeyboardEventArgs e)
    {
        if (e.Key == "Enter") await ExecuteParticipantSearch();
    }
    
    private async Task SearchParticipant(KeyboardEventArgs e) {
        if (e.Key == "Enter")
        {
             await ExecuteParticipantSearch();
        }
    }

    private async Task ExecuteParticipantSearch()
    {
        if (string.IsNullOrWhiteSpace(participantSearchQuery)) return;
        
        isSearchingParticipants = true;
        searchPerformed = true;
        foundParamParticipants.Clear();
        
        try
        {
            if (participantTypeToAdd == "Practitioner")
            {
                var bundle = await FhirService.SearchPractitionersAsync(participantSearchQuery);
                 if (bundle.Entry != null)
                {
                    foundParamParticipants.AddRange(bundle.Entry.Select(e => e.Resource).OfType<Practitioner>());
                }
            }
            else if (participantTypeToAdd == "RelatedPerson")
            {
                var bundle = await FhirService.SearchRelatedPersonsAsync(participantSearchQuery);
                if (bundle.Entry != null)
                {
                    foundParamParticipants.AddRange(bundle.Entry.Select(e => e.Resource).OfType<RelatedPerson>());
                }
            }
        }
        finally
        {
            isSearchingParticipants = false;
        }
    }

    private void SelectParticipant(Resource r)
    {
        if (!participants.Any(p => p.Resource.Id == r.Id))
        {
            participants.Add(new AcpParticipant { Resource = r });
        }
        // Reset search
        participantSearchQuery = "";
        foundParamParticipants.Clear();
        searchPerformed = false;
    }

    private void RemoveParticipant(AcpParticipant p)
    {
        participants.Remove(p);
    }

    private Encounter CreateEncounterResource()
    {
        var encounter = new Encounter();
        // Use existing ID if already created locally, otherwise generate new
        encounter.Id = !string.IsNullOrEmpty(currentEncounterId) ? currentEncounterId : Guid.NewGuid().ToString();
        
        // Identifier
        encounter.Identifier.Add(new Identifier
        {
            System = "https://fauxhr.fhir/namingsystem/resource-identifier",
            Value = Guid.NewGuid().ToString()
        });

        // Status & Class
        encounter.Status = Encounter.EncounterStatus.Finished;
        encounter.Class = new Coding("http://terminology.hl7.org/CodeSystem/v3-ActCode", "IMP", "inpatient encounter");
        
        // Subject -> Patient
        if (AppState.CurrentPatient != null)
        {
            encounter.Subject = new ResourceReference($"Patient/{AppState.CurrentPatient.Id}");
        }

        // Period (Date)
        encounter.Period = new Period { StartElement = new FhirDateTime(encounterDate), EndElement = new FhirDateTime(encounterDate) };

        // Participants
        foreach (var p in participants)
        {
             // Skip Patient in participant list as they are Subject
             if (p.Resource is not Patient)
             {
                 var fhirParticipant = new Encounter.ParticipantComponent();
                 string refStr = $"{p.Resource.TypeName}/{p.Resource.Id}";
                 fhirParticipant.Individual = new ResourceReference(refStr);
                 encounter.Participant.Add(fhirParticipant);
             }
        }
        
        return encounter;
    }

    private void SaveEncounterLocal()
    {
        var encounter = CreateEncounterResource();
        currentEncounterId = encounter.Id;
        
        // Update or Add to local transaction bundle
        var existing = transactionBundleResources.FirstOrDefault(r => r is Encounter && r.Id == currentEncounterId);
        if (existing != null)
        {
            transactionBundleResources.Remove(existing);
        }
        transactionBundleResources.Add(encounter);
        
        Console.WriteLine($"[Local] Encounter Saved: {encounter.Id}");
        
        // Move to next tab
        activeTab = "goal";
    }

    private void SaveGoalLocal()
    {
        // Create Goal Resource
        var goal = new Goal();
        goal.Id = Guid.NewGuid().ToString();
        
        // Identifier
        goal.Identifier.Add(new Identifier
        {
            System = "https://fauxhr.fhir/namingsystem/resource-identifier",
            Value = Guid.NewGuid().ToString()
        });

        // LifecycleStatus - hardcoded to active
        goal.LifecycleStatus = Goal.GoalLifecycleStatus.Active;
        
        // Subject -> Patient
        if (AppState.CurrentPatient != null)
        {
            goal.Subject = new ResourceReference($"Patient/{AppState.CurrentPatient.Id}");
        }

        // Description - SNOMED code
        if (!string.IsNullOrEmpty(goalCode))
        {
            string? display = goalCode switch
            {
                "385987000" => "zorg bij ziekte en/of letsel",
                "1351964001" => "levensverlengende behandeling",
                "713148004" => "voorkomen en behandelen van symptomen",
                _ => null
            };
            
            goal.Description = new CodeableConcept
            {
                Coding = new List<Coding>
                {
                    new Coding("http://snomed.info/sct", goalCode, display)
                }
            };
        }

        // StatusDate - mapped from goalDate (Ingangsdatum)
        goal.StatusDate = goalDate.ToString("yyyy-MM-dd");
        
        // Note (Toelichting)
        if (!string.IsNullOrEmpty(goalNotes))
        {
            goal.Note.Add(new Annotation
            {
                Text = goalNotes
            });
        }
        
        // Add to local transaction bundle
        transactionBundleResources.Add(goal);
        
        Console.WriteLine($"[Local] Goal Created: {goal.Id}");
        
        // Move to next tab
        activeTab = "consent";
    }

    private Consent CreateConsentResource()
    {
        // Create Consent Resource
        var consent = new Consent();
        consent.Id = Guid.NewGuid().ToString();
        
        // Identifier
        consent.Identifier.Add(new Identifier
        {
            System = "https://fauxhr.fhir/namingsystem/resource-identifier",
            Value = Guid.NewGuid().ToString()
        });

        // Status - hardcoded to active
        consent.Status = Consent.ConsentState.Active;
        
        // Scope - treatment
        consent.Scope = new CodeableConcept
        {
            Coding = new List<Coding>
            {
                new Coding("http://terminology.hl7.org/CodeSystem/consentscope", "treatment", "Treatment")
            }
        };
        
        // Category - SNOMED 129125009
        consent.Category.Add(new CodeableConcept
        {
            Coding = new List<Coding>
            {
                new Coding("http://snomed.info/sct", "129125009", "Advance care planning")
            }
        });
        
        // Policy
        consent.Policy.Add(new Consent.PolicyComponent { Uri = "https://wetten.overheid.nl/" });
        
        // Patient - subject
        if (AppState.CurrentPatient != null)
        {
            consent.Patient = new ResourceReference($"Patient/{AppState.CurrentPatient.Id}");
        }

        // DateTime - use encounterDate from the Encounter tab
        consent.DateTimeElement = new FhirDateTime(encounterDate);
        
        // Extension: ext-Comment (Toelichting)
        if (!string.IsNullOrEmpty(consentNotes))
        {
            consent.Extension.Add(new Extension
            {
                Url = "http://nictiz.nl/fhir/StructureDefinition/ext-Comment",
                Value = new FhirString(consentNotes)
            });
        }
        
        // Provision - initialize if null
        if (consent.Provision == null)
        {
            consent.Provision = new Consent.provisionComponent();
        }
        
        // Provision.Type - mapped from Besluit
        if (consentDecision == "permit")
        {
            consent.Provision.Type = Consent.ConsentProvisionType.Permit;
        }
        else if (consentDecision == "deny")
        {
            consent.Provision.Type = Consent.ConsentProvisionType.Deny;
        }
        // If "other", leave provision.type empty and add modifierExtension
        
        // ModifierExtension for "other" decision
        if (consentDecision == "other" && !string.IsNullOrEmpty(consentDecisionOther))
        {
            consent.ModifierExtension.Add(new Extension
            {
                Url = "http://nictiz.nl/fhir/StructureDefinition/ext-TreatmentDirective2.SpecificationOther",
                Value = new FhirString(consentDecisionOther)
            });
        }
        
        // Provision.Code - treatment type
        if (!string.IsNullOrEmpty(consentTreatmentType))
        {
            if (consentTreatmentType == "OTH")
            {
                // Other - use v3.NullFlavor system and add text if specified
                var codeableConcept = new CodeableConcept
                {
                    Coding = new List<Coding>
                    {
                        new Coding("http://terminology.hl7.org/CodeSystem/v3-NullFlavor", "OTH", "Other")
                    }
                };
                
                if (!string.IsNullOrEmpty(consentOtherSpecification))
                {
                    codeableConcept.Text = consentOtherSpecification;
                }
                
                consent.Provision.Code.Add(codeableConcept);
            }
            else
            {
                // SNOMED codes
                string? display = consentTreatmentType switch
                {
                    "305351004" => "opname op intensive care",
                    "89666000" => "cardiopulmonale resuscitatie",
                    "40617009" => "kunstmatige beademing",
                    "116762002" => "toediening van bloedproduct",
                    "281789004" => "antibiotische therapie",
                    "32485007" => "opname in ziekenhuis",
                    _ => null
                };
                
                consent.Provision.Code.Add(new CodeableConcept
                {
                    Coding = new List<Coding>
                    {
                        new Coding("http://snomed.info/sct", consentTreatmentType, display)
                    }
                });
            }
        }
        
        // Provision.Actor - same as Encounter participants
        foreach (var p in participants)
        {
            if (p.Resource is not Patient) // Skip patient as they are already the subject
            {
                // For now, skip adding actors - will be added later if needed
                // The participants are already in the Encounter resource
            }
        }
        
        return consent;
    }

    private void SaveConsentAndAddAnother()
    {
        if (string.IsNullOrEmpty(consentTreatmentType))
        {
            // TODO: Show validation message
            return;
        }
        
        var consent = CreateConsentResource();
        
        // Add to saved list
        savedConsents.Add(consent);
        
        // Add to transaction bundle
        transactionBundleResources.Add(consent);
        
        Console.WriteLine($"[Local] Consent Created: {consent.Id}");
        
        // Clear form for next entry
        ClearConsentForm();
    }
    
    private void ProceedToObservation()
    {
        // Save current consent if form has data
        if (!string.IsNullOrEmpty(consentTreatmentType))
        {
            SaveConsentAndAddAnother();
        }
        
        // Move to next tab
        activeTab = "observation";
    }
    
    private string GetConsentDisplay(Consent consent)
    {
        var treatmentCode = consent.Provision?.Code?.FirstOrDefault();
        var treatmentDisplay = treatmentCode?.Coding?.FirstOrDefault()?.Display ?? treatmentCode?.Text ?? "Onbekend";
        var decision = consent.Provision?.Type?.ToString() ?? "Anders";
        return $"{treatmentDisplay} ({decision})";
    }
    
    private void RemoveConsent(Consent consent)
    {
        savedConsents.Remove(consent);
        transactionBundleResources.Remove(consent);
    }
    
    private void ClearConsentForm()
    {
        consentTreatmentType = "";
        consentDecision = "permit";
        consentDecisionOther = "";
        consentOtherSpecification = "";
        consentNotes = "";
    }

    private void SaveObservationsLocal()
    {
        // 1. Wishes en verwachtingen (153851000146100)
        var obsWishesResource = CreateObservationResource(
            "153851000146100", 
            "Wilsbekwaamheid medische beslissingen", // Mapping name from UI/Concept
            obsWishes, 
            "string");
            
        // Add specific method for Wishes: 370819000
        obsWishesResource.Method = new CodeableConcept
        {
            Coding = new List<Coding> 
            { 
                new Coding("http://snomed.info/sct", "370819000", "vaststellen van persoonlijke waarden en wensen met betrekking tot zorg (verrichting)") 
            }
        };
        transactionBundleResources.Add(obsWishesResource);

        // 2. Preferred place of death (395091006)
        var obsPlaceResource = CreateObservationResource(
            "395091006",
            "Preferred place of death",
            obsPlaceOfDeath,
            "code");
        transactionBundleResources.Add(obsPlaceResource);

        // 3. Standpunt euthanasie (340171000146104)
        var obsEuthanasiaResource = CreateObservationResource(
            "340171000146104",
            "standpunt ten opzichte van euthanasie",
            obsEuthanasia,
            "code");
        transactionBundleResources.Add(obsEuthanasiaResource);

        // 4. Orgaandonatie (570801000146104)
        var obsOrganResource = CreateObservationResource(
            "570801000146104",
            "geregistreerd in orgaan donorregister",
            obsOrganDonation,
            "code");
        transactionBundleResources.Add(obsOrganResource);
    }

    private Observation CreateObservationResource(string code, string display, string valueInput, string valueType)
    {
        var obs = new Observation();
        obs.Id = Guid.NewGuid().ToString();
        
        // Identifier
        obs.Identifier.Add(new Identifier
        {
            System = "https://fauxhr.fhir/namingsystem/resource-identifier",
            Value = Guid.NewGuid().ToString()
        });

        obs.Status = ObservationStatus.Final;
        obs.Effective = new FhirDateTime(encounterDate); // Use date from encounter tab (or observationDate if distinct?) 
        // User requested "effectiveDateTime = date of encounter"

        // Code
        obs.Code = new CodeableConcept
        {
            Coding = new List<Coding>
            {
                new Coding("http://snomed.info/sct", code, display)
            }
        };

        // Subject
        if (AppState.CurrentPatient != null)
        {
            obs.Subject = new ResourceReference($"Patient/{AppState.CurrentPatient.Id}");
        }

        // Performer - Current User
        if (AppState.CurrentPractitioner != null)
        {
            obs.Performer.Add(new ResourceReference($"Practitioner/{AppState.CurrentPractitioner.Id}"));
        }

        // Encounter
        if (!string.IsNullOrEmpty(currentEncounterId))
        {
            obs.Encounter = new ResourceReference($"Encounter/{currentEncounterId}");
        }

        // Value Logic
        bool isUnknown = string.IsNullOrEmpty(valueInput) || valueInput == "UNK";
        
        if (isUnknown)
        {
            obs.DataAbsentReason = new CodeableConcept
            {
                Coding = new List<Coding>
                {
                    new Coding("http://terminology.hl7.org/CodeSystem/data-absent-reason", "asked-unknown", "Asked But Unknown")
                }
            };
        }
        else
        {
            if (valueType == "string")
            {
                obs.Value = new FhirString(valueInput);
            }
            else if (valueType == "code")
            {
                if (valueInput == "OTH")
                {
                    // Map Anders/OTH to NullFlavor OTH in Value
                    obs.Value = new CodeableConcept
                    {
                        Coding = new List<Coding>
                        {
                            new Coding("http://terminology.hl7.org/CodeSystem/v3-NullFlavor", "OTH", "other")
                        }
                    };
                }
                else
                {
                    // SNOMED code
                    // Determine display text (optional but good)
                    string? valDisplay = null; // Use null instead of empty string to avoid validation error
                    obs.Value = new CodeableConcept
                    {
                        Coding = new List<Coding>
                        {
                            new Coding("http://snomed.info/sct", valueInput, valDisplay)
                        }
                    };
                }
            }
        }
        
        return obs;
    }

    private async Task SaveAll()
    {
        // 0. Ensure Encounter exists (even if defaults used)
        if (string.IsNullOrEmpty(currentEncounterId))
        {
             var enc = CreateEncounterResource();
             currentEncounterId = enc.Id;
             // Remove any theoretically existing encounter to be safe
             transactionBundleResources.RemoveAll(r => r is Encounter); 
             transactionBundleResources.Insert(0, enc);
             Console.WriteLine($"[Local] Auto-created Encounter: {enc.Id}");
        }

        // 1. Save local observations
        SaveObservationsLocal();
        
        // 2. Construct Transaction Bundle
        var bundle = new Bundle();
        bundle.Type = Bundle.BundleType.Transaction;
        
        foreach (var resource in transactionBundleResources)
        {
            var entry = new Bundle.EntryComponent();
            entry.Resource = resource;
            entry.Request = new Bundle.RequestComponent
            {
                Method = Bundle.HTTPVerb.POST,
                Url = resource.TypeName 
            };
            bundle.Entry.Add(entry);
        }
        
        preparedBundle = bundle;

        if (AppState.ShowDebugInfo)
        {
            var serializer = new FhirJsonSerializer();
            var rawJson = serializer.SerializeToString(bundle);
            try 
            {
                var doc = System.Text.Json.JsonDocument.Parse(rawJson);
                var opts = new System.Text.Json.JsonSerializerOptions { WriteIndented = true };
                debugBundleJson = System.Text.Json.JsonSerializer.Serialize(doc, opts);
            }
            catch
            {
                debugBundleJson = rawJson;
            }
            showDebugModal = true;
            // Wait for user interaction
        }
        else
        {
            await SendBundle(bundle);
        }
    }

    private async Task ConfirmSend()
    {
        showDebugModal = false;
        if (preparedBundle != null)
        {
            await SendBundle(preparedBundle);
        }
    }

    private void CancelSend()
    {
        showDebugModal = false;
        debugBundleJson = null;
        preparedBundle = null;
        // Rollback: remove observations from transaction list so they aren't duplicated if user tries again
        transactionBundleResources.RemoveAll(r => r is Observation);
    }

    private async Task SendBundle(Bundle bundle)
    {
        try
        {
            // 3. Send to Server
            Console.WriteLine($"[Submit] Sending {bundle.Entry.Count} resources...");
            var response = await FhirService.TransactionAsync(bundle);
            Console.WriteLine($"[Submit] Success! Total: {response.Entry?.Count}");
            
            showSuccessMessage = true;
            transactionBundleResources.Clear(); // Clear local state
            savedConsents.Clear();
        }
        catch (Exception ex)
        {
            Console.WriteLine($"[Submit] Error: {ex.Message}");
            // Handle error (show message)
        }
    }
}
