@page "/acp/overview"
@using FauxHR.Core.Services
@using FauxHR.Modules.ExitStrategy.Services
@using Hl7.Fhir.Model
@using Hl7.Fhir.Serialization
@using Task = System.Threading.Tasks.Task
@inject AppState AppState
@inject AcpDataService AcpService

<PageTitle>Exit Strategy - Overview</PageTitle>

<div class="container-fluid py-4">
    <!-- Header -->
    <div class="d-flex justify-content-between align-items-center mb-4">
        <div>
             <h2 class="display-6 fw-bold text-primary mb-1">
                <i class="bi bi-clipboard-pulse me-3"></i>Exit Strategy (ACP)
            </h2>
            <p class="lead text-muted mb-0">Advance Care Planning implementation guide.</p>
        </div>
        <div>
            @if(AppState.CurrentPatient != null)
            {
                 <button class="btn btn-primary btn-lg" @onclick="PullLatestInfo" disabled="@isLoading">
                    @if(isLoading)
                    {
                        <span class="spinner-border spinner-border-sm me-2"></span>
                    }
                    else
                    {
                        <i class="bi bi-cloud-arrow-down me-2"></i>
                    }
                    Pull Latest Info
                </button>
                <button class="btn btn-outline-primary btn-lg ms-2" @onclick='() => Navigation.NavigateTo("/acp/resources")'>
                    <i class="bi bi-database me-2"></i>View All Resources
                </button>
            }
        </div>
    </div>
    
    @if(AppState.CurrentPatient == null)
    {
        <div class="alert alert-warning shadow-sm border-0">
            <i class="bi bi-exclamation-triangle-fill me-2"></i>
            Please select a patient from the Dashboard to view ACP data.
        </div>
    }
    else
    {
        <!-- Progress Section -->
        @if(queries != null && queries.Any())
        {
            <div class="card border-0 shadow-sm mb-4">
                 <div class="card-header bg-white border-bottom-0 pt-3">
                    <h5 class="fw-normal mb-0">Data Retrieval Progress</h5>
                </div>
                <div class="card-body">
                    <div class="row g-3">
                        @foreach(var q in queries)
                        {
                            <div class="col-md-6 col-lg-3">
                                <div class="d-flex align-items-center p-2 border rounded @GetStatusClass(q) @(q.Status == QueryStatus.Error ? "cursor-pointer" : "")" 
                                     @onclick="() => { if(q.Status == QueryStatus.Error) ShowErrorDetails(q); }">
                                    <div class="me-3">@GetStatusIcon(q)</div>
                                    <div class="text-truncate">
                                        <div class="fw-bold small">@q.Title</div>
                                        <div class="text-xs text-muted">@q.ResourceType</div>
                                    </div>
                                    @if(q.Result != null && q.Result.Total > 0 || (q.Result?.Entry?.Count > 0))
                                    {
                                        <span class="badge bg-success ms-auto">@(q.Result.Total ?? q.Result.Entry.Count)</span>
                                    }
                                </div>
                            </div>
                        }
                    </div>
                </div>
            </div>
            
            <!-- Tiles Grid -->
             <div class="row g-4">
                @foreach (var q in queries.Where(x => x.Status == QueryStatus.Success && (x.Result?.Entry?.Any() == true)))
                {
                    <div class="col-12">
                        <h4 class="fw-light mb-3">@q.Title</h4>
                         <div class="row g-3">
                            @foreach(var entry in q.Result!.Entry)
                            {
                                @if (entry.Resource != null)
                                {
                                    <div class="col-md-6 col-lg-4">
                                         <div class="card h-100 shadow-sm border-0 bg-light">
                                            <div class="card-body">
                                                <span class="badge bg-secondary mb-2">@entry.Resource.TypeName</span>
                                                <h6 class="card-title">@entry.Resource.Id</h6>
                                            <div class="small text-muted text-truncate">
                                                <!-- Simple dump for now, specialized rendering later -->
                                                Resource: @entry.Resource.TypeName
                                            </div>
                                            <div class="mt-3">
                                                 <button class="btn btn-outline-secondary btn-sm" @onclick="() => ViewSource(entry.Resource)">
                                                    <i class="bi bi-code-slash me-1"></i> View Source
                                                </button>
                                            </div>
                                            </div>
                                        </div>
                                    </div>
                                }
                            }
                        </div>
                        <hr class="my-4 text-muted opacity-25" />
                    </div>
                }
            </div>
        }
    }
</div>

<!-- Simple Source Viewer Modal -->
@if (showSourceModal && selectedResourceJson != null)
{
    <div class="modal fade show d-block" tabindex="-1" style="background-color: rgba(0,0,0,0.5);">
        <div class="modal-dialog modal-lg modal-dialog-scrollable">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title">Resource Source</h5>
                    <button type="button" class="btn-close" @onclick="CloseSourceModal"></button>
                </div>
                <div class="modal-body p-0">
                    <pre class="m-0 p-3 bg-dark text-light" style="font-size: 0.85rem; line-height: 1.4;"><code>@selectedResourceJson</code></pre>
                </div>
                 <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" @onclick="CloseSourceModal">Close</button>
                </div>
            </div>
        </div>
    </div>
}

@code {
    [Inject] private NavigationManager Navigation { get; set; } = default!;
    [Inject] private Blazored.LocalStorage.ILocalStorageService LocalStorage { get; set; } = default!;
    
    private List<AcpQuery>? queries;
    private bool isLoading = false;
    
    // Modal State
    private bool showSourceModal = false;
    private string? selectedResourceJson;

    protected override async Task OnInitializedAsync()
    {
        if (AppState.CurrentPatient != null)
        {
            await LoadFromLocalStorage();
        }
    }

    private async Task LoadFromLocalStorage()
    {
        try
        {
            if (AppState.CurrentPatient == null) return;
            
            queries = AcpService.GetQueries(AppState.CurrentPatient.Id);
            
            var keys = await LocalStorage.KeysAsync();
            
            foreach (var query in queries)
            {
                // Check if we have any resources for this query in LocalStorage
                var relevantKeys = keys.Where(k => k.StartsWith($"{query.ResourceType}-")).ToList();
                
                if (relevantKeys.Any())
                {
                    // Mark as success and set a fake bundle with count
                    query.Status = QueryStatus.Success;
                    query.Result = new Bundle 
                    { 
                        Total = relevantKeys.Count,
                        Entry = new List<Bundle.EntryComponent>()
                    };
                }
            }
            
            StateHasChanged();
        }
        catch (Exception ex)
        {
            Console.WriteLine($"Error loading from storage: {ex.Message}");
        }
    }

    private void ViewSource(Hl7.Fhir.Model.Resource resource)
    {
        var serializer = new FhirJsonSerializer();
        var rawJson = serializer.SerializeToString(resource);
        
        // Pretty-print the JSON using System.Text.Json
        try
        {
            var jsonDocument = System.Text.Json.JsonDocument.Parse(rawJson);
            var options = new System.Text.Json.JsonSerializerOptions { WriteIndented = true };
            selectedResourceJson = System.Text.Json.JsonSerializer.Serialize(jsonDocument, options);
        }
        catch
        {
            // If formatting fails, use raw JSON
            selectedResourceJson = rawJson;
        }
        
        showSourceModal = true;
    }

    private void CloseSourceModal()
    {
        showSourceModal = false;
        selectedResourceJson = null;
    }
    
    private void ShowErrorDetails(AcpQuery query)
    {
        if (query.Result?.Entry != null && query.Result.Entry.Any())
        {
            var errorResource = query.Result.Entry.FirstOrDefault(e => e.Resource is OperationOutcome);
            if (errorResource?.Resource != null)
            {
                ViewSource(errorResource.Resource);
            }
        }
    }
    
    // ... existing helpers ...

    private string GetStatusClass(AcpQuery q) => q.Status switch
    {
        QueryStatus.Running => "bg-light border-primary",
        QueryStatus.Success => "bg-success-subtle border-success",
        QueryStatus.Error => "bg-danger-subtle border-danger",
        _ => "bg-white"
    };

    private RenderFragment GetStatusIcon(AcpQuery q) => builder =>
    {
        if (q.Status == QueryStatus.Running)
        {
            builder.AddMarkupContent(0, "<div class='spinner-border text-primary spinner-border-sm'></div>");
        }
        else if (q.Status == QueryStatus.Success)
        {
             builder.AddMarkupContent(0, "<i class='bi bi-check-circle-fill text-success'></i>");
        }
        else if (q.Status == QueryStatus.Error)
        {
             builder.AddMarkupContent(0, "<i class='bi bi-x-circle-fill text-danger'></i>");
        }
        else
        {
             builder.AddMarkupContent(0, "<i class='bi bi-circle text-muted'></i>");
        }
    };

    private async Task PullLatestInfo()
    {
        if (AppState.CurrentPatient?.Id == null) return;
        
        isLoading = true;
        
        // Clear existing data from LocalStorage before pulling fresh data
        try
        {
            await LocalStorage.ClearAsync();
        }
        catch (Exception ex)
        {
            Console.WriteLine($"Error clearing storage: {ex.Message}");
        }
        
        queries = AcpService.GetQueries(AppState.CurrentPatient.Id);
        StateHasChanged();

        // Run sequential or parallel? Sequential better for "menu" visual feel.
        foreach(var q in queries)
        {
            await AcpService.ExecuteQueryAsync(q);
            StateHasChanged(); // Update UI after each step
            await Task.Delay(200); // Artificial delay for visual effect? Optional.
        }
        
        isLoading = false;
    }
}
