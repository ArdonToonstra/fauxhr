@using Hl7.Fhir.Model
@using FauxHR.Modules.ExitStrategy.Helpers

<div class="modal fade show d-block" tabindex="-1" style="background-color: rgba(0,0,0,0.5);">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title">
                    @(Observation.Code?.Coding?.FirstOrDefault()?.Display ?? Observation.Code?.Text ?? "Detail")
                </h5>
                <button type="button" class="btn-close" @onclick="OnClose"></button>
            </div>
            <div class="modal-body">
                <div class="mb-3">
                    <label class="text-muted small d-block">Waarde</label>
                    <div class="fs-5 fw-bold text-primary">
                        @if (Observation.Value is CodeableConcept cc)
                        {
                            @(cc.Coding?.FirstOrDefault()?.Display ?? cc.Text ?? "-")
                        }
                        else if (Observation.Value is FhirString s)
                        {
                            @s.Value
                        }
                        else if (Observation.Value is FhirBoolean b)
                        {
                            @(b.Value == true ? "Ja" : "Nee")
                        }
                        else if (Observation.Value is Quantity q)
                        {
                            @q.Value @q.Unit
                        }
                        else
                        {
                            <span class="text-muted">-</span>
                        }
                    </div>
                </div>

                <div class="row g-3">
                    <div class="col-6">
                        <label class="text-muted small d-block">Datum</label>
                        <div>
                            @if (Observation.Effective is FhirDateTime dt && !string.IsNullOrEmpty(dt.Value))
                            {
                                @DateTime.Parse(dt.Value).ToString("g")
                            }
                            else if (Observation.Issued.HasValue)
                            {
                                @Observation.Issued.Value.ToString("g")
                            }
                            else
                            {
                                <span>-</span>
                            }
                        </div>
                    </div>
                    <div class="col-6">
                        <label class="text-muted small d-block">Status</label>
                        <div>@(Observation.Status?.ToString() ?? "-")</div>
                    </div>
                </div>

                @if (Observation.Method != null)
                {
                    <div class="mt-3">
                        <label class="text-muted small d-block">Methode</label>
                        <div>
                            @(Observation.Method.Coding?.FirstOrDefault()?.Display ?? Observation.Method.Text ?? "-")
                        </div>
                    </div>
                }

                @if (Observation.Note.Any())
                {
                    <div class="mt-3 pt-3 border-top">
                        <label class="text-muted small d-block fw-bold mb-1">Notities</label>
                        @foreach (var note in Observation.Note)
                        {
                            <div class="mb-1 fst-italic bg-light p-2 rounded small">@note.Text</div>
                        }
                    </div>
                }

                @if (!string.IsNullOrEmpty(Observation.Meta?.Source))
                {
                    <div class="mt-3">
                        <label class="text-muted small d-block">Bron</label>
                        <div>
                             <i class="bi bi-hdd-network me-1 small"></i>
                             @SourceDisplayHelper.GetSourceLabel(Observation.Meta.Source)
                        </div>
                    </div>
                }

                <details class="mt-3 pt-3 border-top text-muted small user-select-all">
                    <summary class="fw-bold mb-1" style="cursor: pointer;">Technische details</summary>
                    <div class="mt-2">ID: @Observation.Id</div>
                    @if (Observation.Meta != null)
                    {
                        <div class="d-flex justify-content-between mt-1">
                            <span class="text-nowrap">Versie: @(Observation.Meta.VersionId ?? "-")</span>
                        </div>
                        <div class="d-flex justify-content-between mt-1">
                            <span class="text-truncate">Updated: @(Observation.Meta.LastUpdated?.ToString("g") ?? "-")</span>
                        </div>
                    }
                     @if (Observation.Identifier.Any())
                    {
                        <div class="mt-1 text-break">
                            IDs: @string.Join(", ", Observation.Identifier.Select(i => $"{i.System}|{i.Value}"))
                        </div>
                    }
                </details>
            </div>
        </div>
    </div>
</div>

@code {
    [Parameter, EditorRequired] public Observation Observation { get; set; } = new();
    [Parameter] public EventCallback OnClose { get; set; }
}
