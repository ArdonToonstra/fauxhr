@page "/user"
@using FauxHR.Core.Services
@using FauxHR.Core.Interfaces
@using Hl7.Fhir.Model
@using Task = System.Threading.Tasks.Task
@inject AppState AppState
@inject NavigationManager Navigation
@inject IFhirService FhirService

<PageTitle>User Context</PageTitle>

<div class="container py-4">
    <div class="d-flex justify-content-between align-items-center mb-4">
        <div>
            <h2 class="display-6 fw-bold text-primary mb-1">
                <i class="bi bi-person-badge me-3"></i>User Context
            </h2>
            <p class="text-muted small mb-0">Current logged-in user (Practitioner)</p>
        </div>
        <button class="btn btn-outline-secondary" @onclick="GoBack">
            <i class="bi bi-arrow-left me-2"></i>Back
        </button>
    </div>

    @if (AppState.CurrentPractitioner == null)
    {
        <div class="alert alert-warning">
            <i class="bi bi-exclamation-triangle me-2"></i>
            No user context loaded.
        </div>
    }
    else
    {
        <!-- Practitioner Card -->
        <div class="card border-0 shadow-sm mb-4">
            <div class="card-body p-4">
                <div class="d-flex align-items-start mb-4">
                    <div class="bg-primary-subtle text-primary rounded-circle p-3 me-3" style="width: 64px; height: 64px;">
                        <i class="bi bi-person-fill fs-2"></i>
                    </div>
                    <div class="flex-grow-1">
                        <h4 class="mb-1">@GetPractitionerName(AppState.CurrentPractitioner)</h4>
                        @if (AppState.CurrentPractitionerRole != null)
                        {
                            <div class="text-muted">
                                @GetSpecialty()
                            </div>
                        }
                        <div class="mt-2">
                            <span class="badge bg-success">
                                <i class="bi bi-person-check me-1"></i>Active
                            </span>
                        </div>
                    </div>
                </div>

                <hr/>

                <div class="row g-4">
                    <div class="col-md-6">
                        <h6 class="text-muted small fw-bold mb-3">IDENTIFICATION</h6>
                        @if (AppState.CurrentPractitioner.Identifier.Any())
                        {
                            @foreach (var identifier in AppState.CurrentPractitioner.Identifier)
                            {
                                <div class="mb-2">
                                    <small class="text-muted d-block">@identifier.System</small>
                                    <div class="fw-medium">@identifier.Value</div>
                                </div>
                            }
                        }
                        else
                        {
                            <div class="text-muted small">No identification</div>
                        }
                    </div>

                    <div class="col-md-6">
                        <h6 class="text-muted small fw-bold mb-3">CONTACT DETAILS</h6>
                        @if (GetTelecoms().Any())
                        {
                            @foreach (var telecom in GetTelecoms())
                            {
                                <div class="mb-2">
                                    <i class="bi bi-@GetTelecomIcon(telecom.System) me-2"></i>
                                    @if (telecom.System == ContactPoint.ContactPointSystem.Email)
                                    {
                                        <a href="mailto:@telecom.Value">@telecom.Value</a>
                                    }
                                    else if (telecom.System == ContactPoint.ContactPointSystem.Phone)
                                    {
                                        <a href="tel:@telecom.Value">@telecom.Value</a>
                                    }
                                    else
                                    {
                                        <span>@telecom.Value</span>
                                    }
                                    @if (telecom.Use.HasValue)
                                    {
                                        <small class="text-muted ms-2">(@telecom.Use)</small>
                                    }
                                </div>
                            }
                        }
                        else
                        {
                            <div class="text-muted small">No contact details</div>
                        }
                    </div>

                    @if (AppState.CurrentPractitioner.Address.Any())
                    {
                        <div class="col-12">
                            <h6 class="text-muted small fw-bold mb-3">ADDRESS</h6>
                            @foreach (var address in AppState.CurrentPractitioner.Address)
                            {
                                <div class="mb-2">
                                    @if (address.Line.Any())
                                    {
                                        @foreach (var line in address.Line)
                                        {
                                            <div>@line</div>
                                        }
                                    }
                                    <div>
                                        @address.PostalCode @address.City
                                    </div>
                                    @if (!string.IsNullOrEmpty(address.Country))
                                    {
                                        <div>@address.Country</div>
                                    }
                                </div>
                            }
                        </div>
                    }

                    <div class="col-md-6">
                        <h6 class="text-muted small fw-bold mb-3">GENDER</h6>
                        <div>
                            @if (AppState.CurrentPractitioner.Gender.HasValue)
                            {
                                <span class="badge bg-info-subtle text-info-emphasis">
                                    <i class="bi bi-gender-ambiguous me-1"></i> @AppState.CurrentPractitioner.Gender.Value.ToString()
                                </span>
                            }
                            else
                            {
                                <span class="text-muted small">Not specified</span>
                            }
                        </div>
                    </div>
                </div>
            </div>
        </div>
    }

    <!-- Search Section -->
    <div class="card border-0 shadow-sm mt-5">
        <div class="card-body p-4">
            <h5 class="card-title mb-4">
                <i class="bi bi-search me-2"></i>Switch User
            </h5>
            
            <div class="row g-4">
                 <!-- Search by ID -->
                <div class="col-md-4 border-end-md">
                    <h6 class="text-uppercase text-muted small fw-bold mb-3">Search by ID</h6>
                    <div class="input-group">
                        <input @bind="searchId" @bind:event="oninput" @onkeyup="@(e => KeyUp(e, "ID"))" type="text" class="form-control" placeholder="e.g. prac-123" />
                        <button class="btn btn-primary" @onclick="SearchById" disabled="@isSearching">
                            <i class="bi bi-search"></i>
                        </button>
                    </div>
                </div>
                
                 <!-- Search by Name -->
                <div class="col-md-4">
                     <h6 class="text-uppercase text-muted small fw-bold mb-3">Search by Name</h6>
                    <div class="input-group">
                        <input @bind="searchName" @bind:event="oninput" @onkeyup="@(e => KeyUp(e, "NAME"))" type="text" class="form-control" placeholder="e.g. Peters" />
                        <button class="btn btn-primary" @onclick="SearchByName" disabled="@isSearching">
                            <i class="bi bi-search"></i>
                        </button>
                    </div>
                </div>
            </div>

             <!-- Search Feedback -->
            @if (isSearching)
            {
                <div class="alert alert-info mt-3 mb-0 py-2">
                    <div class="spinner-border spinner-border-sm me-2"></div> Searching...
                </div>
            }
            else if (!string.IsNullOrEmpty(feedbackMessage))
            {
                <div class="alert @feedbackClass mt-3 mb-0 py-2 d-flex justify-content-between align-items-center">
                    <span>@feedbackMessage</span>
                    @if(foundPractitioners != null && foundPractitioners.Any())
                    {
                        <span class="small text-muted">Found @foundPractitioners.Count result(s)</span>
                    }
                </div>
            }
            
            <!-- Search Results (Tiles) -->
            @if (foundPractitioners != null && foundPractitioners.Any())
            {
                 <div class="row g-3 mt-3">
                    @foreach(var p in foundPractitioners)
                    {
                        <div class="col-sm-6 col-lg-4">
                            <div class="card h-100 shadow-sm user-card cursor-pointer" @onclick="() => SelectPractitioner(p)" style="cursor: pointer;">
                                <div class="card-body">
                                    <div class="d-flex align-items-center gap-3 mb-3">
                                         <div class="bg-primary-subtle text-primary rounded-circle d-flex align-items-center justify-content-center flex-shrink-0" style="width: 48px; height: 48px;">
                                            <i class="bi bi-person-fill fs-4"></i>
                                        </div>
                                        <div>
                                             <h6 class="card-title fw-bold mb-0">@GetPractitionerName(p)</h6>
                                             <span class="badge bg-light text-secondary border">@p.Id</span>
                                        </div>
                                    </div>
                                    
                                     <div class="d-flex justify-content-between text-muted small">
                                        <span class="text-truncate" style="max-width: 100%;">
                                            @if(p.Telecom.Any(t => t.System == ContactPoint.ContactPointSystem.Email))
                                            {
                                                <i class="bi bi-envelope me-1"></i> @p.Telecom.First(t => t.System == ContactPoint.ContactPointSystem.Email).Value
                                            }
                                        </span>
                                    </div>
                                </div>
                            </div>
                        </div>
                    }
                </div>
            }

        </div>
    </div>


    <!-- Debug Info -->
    @if (AppState.CurrentPractitioner != null)
    {
        <div class="card border-0 bg-light mt-4">
            <div class="card-body p-3">
                <details>
                    <summary class="text-muted small fw-bold" style="cursor: pointer;">
                        <i class="bi bi-code-slash me-2"></i>DEBUG INFO
                    </summary>
                    <div class="mt-3">
                        <div class="mb-2">
                            <small class="text-muted d-block">Practitioner ID:</small>
                            <code class="small">@AppState.CurrentPractitioner.Id</code>
                        </div>
                        @if (AppState.CurrentPractitionerRole != null)
                        {
                            <div class="mb-2">
                                <small class="text-muted d-block">PractitionerRole ID:</small>
                                <code class="small">@AppState.CurrentPractitionerRole.Id</code>
                            </div>
                        }
                    </div>
                </details>
            </div>
        </div>
    }
</div>

@code {
    private string searchId = "";
    private string searchName = "";
    private bool isSearching = false;
    private string feedbackMessage = "";
    private string feedbackClass = "";
    private List<Practitioner>? foundPractitioners;

    protected override void OnInitialized()
    {
        AppState.OnChange += StateHasChanged;
    }

    private void GoBack()
    {
        Navigation.NavigateTo("");
    }

    private string GetPractitionerName(Practitioner p)
    {
        if (p?.Name?.FirstOrDefault() is HumanName name)
        {
            var prefix = name.Prefix.Any() ? string.Join(" ", name.Prefix) + " " : "";
            var given = string.Join(" ", name.Given ?? Array.Empty<string>());
            return $"{prefix}{given} {name.Family}".Trim();
        }
        return "Unknown";
    }

    private string GetSpecialty()
    {
        if (AppState.CurrentPractitionerRole?.Specialty != null)
        {
            var specialties = AppState.CurrentPractitionerRole.Specialty
                .SelectMany(s => s.Coding ?? new List<Coding>())
                .Select(c => c.Display ?? c.Code)
                .Where(d => !string.IsNullOrEmpty(d));
            
            return string.Join(", ", specialties);
        }
        return "No specialty specified";
    }

    private List<ContactPoint> GetTelecoms()
    {
        var telecoms = new List<ContactPoint>();
        
        if (AppState.CurrentPractitioner?.Telecom != null)
        {
            telecoms.AddRange(AppState.CurrentPractitioner.Telecom);
        }
        
        // Add role telecoms if not duplicate
        if (AppState.CurrentPractitionerRole?.Telecom != null)
        {
            foreach (var telecom in AppState.CurrentPractitionerRole.Telecom)
            {
                if (!telecoms.Any(t => t.Value == telecom.Value))
                {
                    telecoms.Add(telecom);
                }
            }
        }
        
        return telecoms;
    }

    private string GetTelecomIcon(ContactPoint.ContactPointSystem? system)
    {
        return system switch
        {
            ContactPoint.ContactPointSystem.Phone => "telephone",
            ContactPoint.ContactPointSystem.Email => "envelope",
            ContactPoint.ContactPointSystem.Fax => "printer",
            ContactPoint.ContactPointSystem.Url => "globe",
            _ => "chat"
        };
    }

    private async Task KeyUp(KeyboardEventArgs e, string mode)
    {
        if (e.Key == "Enter")
        {
            switch(mode)
            {
                case "ID": await SearchById(); break;
                case "NAME": await SearchByName(); break;
            }
        }
    }

    private void ResetSearch()
    {
        feedbackMessage = "";
        foundPractitioners = null;
    }

    private async Task SearchById()
    {
        if (string.IsNullOrWhiteSpace(searchId)) return;
        ResetSearch();
        isSearching = true;

        try
        {
            var p = await FhirService.GetPractitionerByIdAsync(searchId);
            if (p != null)
            {
                SelectPractitioner(p);
            }
            else
            {
                feedbackMessage = $"Practitioner with ID '{searchId}' not found.";
                feedbackClass = "alert-danger";
            }
        }
        catch (Exception ex)
        {
            feedbackMessage = $"Error: {ex.Message}";
            feedbackClass = "alert-danger";
        }
        finally { isSearching = false; }
    }

    private async Task SearchByName()
    {
        if (string.IsNullOrWhiteSpace(searchName)) return;
        ResetSearch();
        isSearching = true;

        try
        {
            var bundle = await FhirService.SearchPractitionersAsync(searchName);
            var results = bundle.Entry?.Select(e => e.Resource as Practitioner).Where(p => p != null).Cast<Practitioner>().ToList() ?? new List<Practitioner>();
            
            if (results.Any())
            {
                foundPractitioners = results;
                feedbackMessage = "Select a user from the results below.";
                feedbackClass = "alert-info";
            }
            else
            {
                feedbackMessage = $"No practitioners found matching '{searchName}'.";
                feedbackClass = "alert-warning";
            }
        }
        catch (Exception ex)
        {
            feedbackMessage = $"Error: {ex.Message}";
            feedbackClass = "alert-danger";
        }
        finally { isSearching = false; }
    }

    private void SelectPractitioner(Practitioner p)
    {
        AppState.SetPractitioner(p);
        feedbackMessage = $"Context switched to: {GetPractitionerName(p)}";
        feedbackClass = "alert-success";
        foundPractitioners = null;
    }
}
