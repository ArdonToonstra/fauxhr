@page "/settings"
@using FauxHR.Core.Services
@using FauxHR.Core.Interfaces
@inject AppState AppState
@inject IFhirService FhirService

<PageTitle>FauxHR - Settings</PageTitle>

<div class="container-fluid py-4">
    <div class="row mb-4">
        <div class="col">
            <h2 class="fw-light">Settings</h2>
            <p class="text-muted">Configure your environment.</p>
        </div>
    </div>

    <div class="row">
        <div class="col-md-6">
            <div class="card shadow-sm border-0">
                <div class="card-body">
                    <h5 class="card-title mb-3">FHIR Servers</h5>
                    
                    <div class="list-group mb-3">
                        @foreach (var server in AppState.AvailableServers)
                        {
                            <div class="list-group-item d-flex justify-content-between align-items-center">
                                <div>
                                    <div class="fw-bold">@server.Label</div>
                                    <div class="small text-muted">@server.Url</div>
                                </div>
                                <div>
                                    @if(server.Url == AppState.CurrentServerUrl)
                                    {
                                        <span class="badge bg-success me-2">Active</span>
                                    }
                                    else
                                    {
                                        <button class="btn btn-sm btn-outline-primary me-2" @onclick="() => SetActiveServer(server.Url)">Use</button>
                                        <button class="btn btn-sm btn-outline-danger" @onclick="() => RemoveServer(server.Url)">
                                            <i class="bi bi-trash"></i>
                                        </button>
                                    }
                                </div>
                            </div>
                        }
                    </div>

                    <div class="border-top pt-3">
                        <label class="form-label small fw-bold">Add New Server</label>
                        <div class="row g-2">
                            <div class="col-4">
                                <input type="text" class="form-control form-control-sm" placeholder="Label" @bind="newServerLabel" />
                            </div>
                            <div class="col-6">
                                <input type="text" class="form-control form-control-sm" placeholder="https://..." @bind="newServerUrl" />
                            </div>
                            <div class="col-2">
                                <button class="btn btn-sm btn-secondary w-100" @onclick="AddServer">Add</button>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <div class="col-md-6">
            <div class="card shadow-sm border-0">
                <div class="card-body">
                    <h5 class="card-title mb-3">Debug Tools</h5>
                    <p class="card-text">Quickly load test data.</p>
                    
                    <button class="btn btn-outline-primary mb-2" @onclick="LoadDefaultPatient" disabled="@isLoading">
                        @if(isLoading) { <span>Loading...</span> } else { <span>Load "Hendrik Hartman"</span> }
                    </button>
                    
                    @if (!string.IsNullOrEmpty(loadMessage))
                    {
                        <div class="mt-2 text-small @messageClass">
                            @loadMessage
                        </div>
                    }

                    <div class="border-top pt-3 mt-3">
                        <div class="form-check form-switch">
                            <input class="form-check-input" type="checkbox" id="showDebugInfo" 
                                   checked="@AppState.ShowDebugInfo" 
                                   @onchange="@(e => AppState.SetShowDebugInfo((bool)e.Value!))" />
                            <label class="form-check-label" for="showDebugInfo">Enable Debug Mode (Show JSON)</label>
                        </div>
                    </div>
                </div>
            </div>
        </div>
        
        <div class="col-md-6">
            <div class="card shadow-sm border-0">
                <div class="card-body">
                    <h5 class="card-title mb-3">Reference Resolution</h5>                    
                    <div class="mb-3">
                        <div class="form-check form-switch">
                            <input class="form-check-input" type="checkbox" id="enableReferences" 
                                   @bind="enableReferences" />
                            <label class="form-check-label" for="enableReferences">
                                Enable automatic reference resolution
                            </label>
                        </div>
                    </div>

                    <div class="mb-3">
                        <label class="form-label">Resolution Depth: @resolutionDepth level(s)</label>
                        <input type="range" class="form-range" min="1" max="5" 
                               @bind="resolutionDepth" @bind:event="oninput" 
                               disabled="@(!enableReferences)" />
                        <div class="form-text">
                            Level 1: Direct references only. Level 3 (recommended).
                        </div>
                    </div>

                    <button class="btn btn-primary" @onclick="SaveReferenceSettings">Save Settings</button>
                    @if (referenceSaved)
                    {
                        <span class="text-success ms-2 fade-in">Saved!</span>
                    }
                </div>
            </div>
        </div>

        <div class="col-md-6 mt-4">
            <div class="card shadow-sm border-0">
                <div class="card-body">
                    <h5 class="card-title mb-3">Conformance Testing</h5>
                    
                    <div class="form-check form-switch mb-3">
                        <input class="form-check-input" type="checkbox" id="conformanceMode" 
                               @bind="conformanceMode" />
                        <label class="form-check-label" for="conformanceMode">
                            Enable Conformance Testing Mode
                        </label>
                    </div>

                    @if (conformanceMode)
                    {
                        <div class="alert alert-warning small mb-3">
                            <i class="bi bi-exclamation-triangle me-1"></i>
                            Custom headers will be added to <strong>all</strong> outgoing FHIR requests.
                        </div>

                        <div class="table-responsive mb-3">
                            <table class="table table-sm table-bordered">
                                <thead class="table-light">
                                    <tr>
                                        <th>Header</th>
                                        <th>Value</th>
                                        <th style="width: 50px;"></th>
                                    </tr>
                                </thead>
                                <tbody>
                                    @foreach (var header in customHeaders)
                                    {
                                        <tr>
                                            <td>
                                                <input type="text" class="form-control form-control-sm border-0" @bind="header.Key" placeholder="Key" />
                                            </td>
                                            <td>
                                                <input type="text" class="form-control form-control-sm border-0" @bind="header.Value" placeholder="Value" />
                                            </td>
                                            <td class="text-center">
                                                <button class="btn btn-link link-danger p-0" @onclick="() => RemoveHeader(header)">
                                                    <i class="bi bi-x-lg"></i>
                                                </button>
                                            </td>
                                        </tr>
                                    }
                                </tbody>
                            </table>
                        </div>
                        
                        <div class="d-flex justify-content-between mb-4">
                            <button class="btn btn-sm btn-outline-secondary" @onclick="AddHeader">
                                <i class="bi bi-plus-lg me-1"></i> Add Header
                            </button>
                        </div>
                    }

                    <div class="d-flex align-items-center">
                        <button class="btn btn-primary" @onclick="SaveConformanceSettings">Save Conformance Settings</button>
                        @if (conformanceSaved)
                        {
                            <span class="text-success ms-2 fade-in">Saved!</span>
                        }
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

@code {
    private string newServerLabel = "";
    private string newServerUrl = "";
    
    private bool isLoading = false;
    private bool referenceSaved = false;
    private string loadMessage = "";
    private string messageClass = "";
    
    private bool enableReferences = true;
    private int resolutionDepth = 3;

    // Conformance Settings
    private bool conformanceMode = false;
    private bool conformanceSaved = false;
    private List<HeaderItem> customHeaders = new();

    protected override void OnInitialized()
    {
        enableReferences = AppState.EnableReferenceResolution;
        resolutionDepth = AppState.ReferenceResolutionDepth;

        conformanceMode = AppState.ConformanceTestingMode;
        // Copy list to avoid direct state mutation before save
        customHeaders = AppState.CustomHeaders.Select(h => new HeaderItem { Key = h.Key, Value = h.Value }).ToList();
    }

    private void SaveReferenceSettings()
    {
        AppState.SetReferenceResolutionSettings(enableReferences, resolutionDepth);
        referenceSaved = true;
        // Reset message after time?
        Task.Delay(2000).ContinueWith(_ => InvokeAsync(() => { referenceSaved = false; StateHasChanged(); }));
    }

    private void AddServer()
    {
        if (!string.IsNullOrWhiteSpace(newServerUrl) && !string.IsNullOrWhiteSpace(newServerLabel))
        {
            AppState.AddServer(newServerUrl, newServerLabel);
            newServerUrl = "";
            newServerLabel = "";
        }
    }

    private void RemoveServer(string url)
    {
        AppState.RemoveServer(url);
    }

    private void SetActiveServer(string url)
    {
        AppState.SetServerUrl(url);
    }

    private async Task LoadDefaultPatient()
    {
        isLoading = true;
        loadMessage = "";
        try
        {
            // Try to find Hendrik Hartman: 999911120 | http://fhir.nl/fhir/NamingSystem/bsn
            var patient = await FhirService.SearchPatientByIdentifierAsync("http://fhir.nl/fhir/NamingSystem/bsn", "999911120");
            
            if (patient != null)
            {
                AppState.SetPatient(patient);
                loadMessage = "Patient loaded successfully!";
                messageClass = "text-success";
            }
            else
            {
                loadMessage = "Patient not found on this server.";
                messageClass = "text-danger";
            }
        }
        catch (Exception ex)
        {
            loadMessage = $"Error: {ex.Message}";
            messageClass = "text-danger";
        }
        finally
        {
            isLoading = false;
        }
        }


    private void AddHeader()
    {
        customHeaders.Add(new HeaderItem());
    }

    private void RemoveHeader(HeaderItem item)
    {
        customHeaders.Remove(item);
    }

    private void SaveConformanceSettings()
    {
        // Filter out empty keys
        var validHeaders = customHeaders.Where(h => !string.IsNullOrWhiteSpace(h.Key)).ToList();
        AppState.SetConformanceSettings(conformanceMode, validHeaders);
        
        conformanceSaved = true;
        Task.Delay(2000).ContinueWith(_ => InvokeAsync(() => { conformanceSaved = false; StateHasChanged(); }));
    }
}
